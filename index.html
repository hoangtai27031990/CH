<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>H·ªÜ TH·ªêNG QU·∫¢N L√ù HSD ‚Äì Saigon Co.op</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<style>
body{background:#f3f4f6}
.card{background:#fff;border-radius:14px;box-shadow:0 4px 16px rgba(0,0,0,.08)}
.brand-bg{background:#c40018}
.brand-text{color:#c40018}

/* c·∫£nh b√°o */
.blink30{animation:blink30 .6s linear infinite;border:2px solid #fb923c}
@keyframes blink30{0%{background:#fff3e0}50%{background:#ff9800}100%{background:#fff3e0}}
.blink20{animation:blink20 .6s linear infinite;border:2px solid #ef4444}
@keyframes blink20{0%{background:#fff1f2}50%{background:#fecaca}100%{background:#fff1f2}}

/* scan focus */
.scan-box{position:relative}
.scan-line{
 position:absolute;
 top:50%;left:5%;width:90%;height:2px;
 background:red;
 animation:scanMove 1.2s linear infinite;
}
@keyframes scanMove{0%{top:30%}50%{top:55%}100%{top:80%}}

.filter-btn{padding:6px 12px;border-radius:6px;border:1px solid #ddd;background:#f5f5f5}
.filter-btn.active{background:#2563eb;color:#fff}

#alertPopup{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:2000}
.popup-30{border:3px solid #fb923c}
.popup-20{border:3px solid #ef4444}
</style>
</head>

<body class="max-w-xl mx-auto p-3">

<!-- POPUP -->
<div id="alertPopup" class="hidden items-center justify-center">
 <div id="popupBox" class="bg-white p-5 rounded-xl w-[90%] max-w-sm text-center">
  <div id="popupTitle" class="font-bold text-lg mb-2"></div>
  <div id="popupMsg" class="mb-4"></div>
  <button onclick="closePopup()" class="brand-bg text-white px-4 py-2 rounded">ƒê√£ hi·ªÉu</button>
 </div>
</div>

<div class="card p-4 space-y-3">

<label class="font-semibold">Barcode s·∫£n ph·∫©m</label>
<div class="flex gap-2">
 <input id="barcode" class="border p-2 rounded w-full">
 <button onclick="startScan()" class="brand-bg text-white px-3 rounded">Qu√©t</button>
</div>

<div id="reader" class="hidden scan-box mt-2">
 <div class="scan-line"></div>
</div>

<label class="font-semibold">Ng√†y s·∫£n xu·∫•t (NSX)</label>
<input type="date" id="nsx" class="border p-2 rounded w-full">

<label class="font-semibold">H·∫°n s·ª≠ d·ª•ng (HSD)</label>
<input type="date" id="hsd" class="border p-2 rounded w-full">

<div class="grid grid-cols-2 gap-2">
 <button onclick="calculate()" class="brand-bg text-white py-2 rounded">T√çNH K·∫æT QU·∫¢</button>
 <button onclick="resetForm()" class="bg-gray-500 text-white py-2 rounded">T√çNH L·∫†I</button>
</div>

<div id="result"></div>

<div class="grid grid-cols-2 gap-2">
 <button onclick="exportExcel()" class="bg-slate-700 text-white py-2 rounded">Xu·∫•t Excel</button>
 <button onclick="clearHistory()" class="bg-red-600 text-white py-2 rounded">X√≥a l·ªãch s·ª≠</button>
</div>

<div id="statistic" class="text-sm"></div>
</div>

<div class="card p-3 mt-4">
<h2 class="font-bold brand-text mb-2">L·ªãch s·ª≠ t√≠nh to√°n</h2>

<div class="flex gap-2 mb-2">
 <button id="f-all" onclick="setFilter('all')" class="filter-btn active">T·∫•t c·∫£</button>
 <button id="f-30" onclick="setFilter('30')" class="filter-btn">Gi·∫£i t·ªìn</button>
 <button id="f-20" onclick="setFilter('20')" class="filter-btn">R√∫t h√†ng</button>
</div>

<div id="history" class="text-sm space-y-1 max-h-64 overflow-auto"></div>
</div>

<script>
const historyKey="coop_hsd_history";
let qr,currentFilter="all";

/* t·ªëi ∆∞u qu√©t barcode */
const scanConfig={
 fps:10,
 qrbox:{width:260,height:120},
 disableFlip:true,
 experimentalFeatures:{useBarCodeDetectorIfSupported:true}
};

function startScan(){
 reader.classList.remove("hidden");
 if(!qr) qr=new Html5Qrcode("reader");
 qr.start({facingMode:"environment"},scanConfig,code=>{
  barcode.value=code;
  qr.stop().then(()=>reader.classList.add("hidden"));
 });
}

function calculate(){
 if(!nsx.value||!hsd.value) return alert("Nh·∫≠p ƒë·ªß NSX & HSD");
 const a=new Date(nsx.value),b=new Date(hsd.value);
 if(b<=a) return alert("HSD ph·∫£i l·ªõn h∆°n NSX");

 const total=(b-a)/86400000;
 const d30=new Date(a.getTime()+total*0.7*86400000);
 const d20=new Date(a.getTime()+total*0.8*86400000);
 const today=new Date();

 result.innerHTML=`
 <div class="border p-3 ${today>=d30?'blink30':''}">
  M·ªëc 30%: ${d30.toLocaleDateString("vi-VN")}
 </div>
 <div class="border p-3 ${today>=d20?'blink20':''}">
  M·ªëc 20%: ${d20.toLocaleDateString("vi-VN")}
 </div>`;

 saveHistory(today>=d30?"Gi·∫£i t·ªìn":"B√¨nh th∆∞·ªùng",today>=d20?"R√∫t h√†ng":"B√¨nh th∆∞·ªùng");
}

function saveHistory(f30,f20){
 const h=JSON.parse(localStorage.getItem(historyKey)||"[]");
 h.unshift({Barcode:barcode.value,NSX:nsx.value,HSD:hsd.value,"30%":f30,"20%":f20,Time:new Date().toLocaleString("vi-VN")});
 localStorage.setItem(historyKey,JSON.stringify(h));
 renderHistory();
}

function renderHistory(){
 let h=JSON.parse(localStorage.getItem(historyKey)||"[]");
 if(currentFilter==="30") h=h.filter(x=>x["30%"]==="Gi·∫£i t·ªìn");
 if(currentFilter==="20") h=h.filter(x=>x["20%"]==="R√∫t h√†ng");

 history.innerHTML=h.map(x=>`
 <div class="border-b">
  <b>${x.Barcode}</b><br>
  30%: ${x["30%"]} | 20%: ${x["20%"]}
 </div>`).join("");

 statistic.innerHTML="üì¶ T·ªïng: "+h.length;
}

function setFilter(f){
 currentFilter=f;
 document.querySelectorAll(".filter-btn").forEach(b=>b.classList.remove("active"));
 document.getElementById("f-"+f).classList.add("active");
 renderHistory();
}

function exportExcel(){
 const h=JSON.parse(localStorage.getItem(historyKey)||"[]");
 if(!h.length) return alert("Kh√¥ng c√≥ d·ªØ li·ªáu");
 const ws=XLSX.utils.json_to_sheet(h);
 const wb=XLSX.utils.book_new();
 XLSX.utils.book_append_sheet(wb,ws,"HSD");
 XLSX.writeFile(wb,"saigoncoop_hsd.xlsx");
 showPopup("export");
}

function clearHistory(){localStorage.removeItem(historyKey);renderHistory()}
function resetForm(){barcode.value="";nsx.value="";hsd.value="";result.innerHTML=""}

function showPopup(type){
 popupTitle.innerText="Xu·∫•t file th√†nh c√¥ng";
 popupMsg.innerText="D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c t·∫£i v·ªÅ.";
 alertPopup.classList.remove("hidden");
 alertPopup.classList.add("flex");
 setTimeout(closePopup,2000);
}
function closePopup(){alertPopup.classList.add("hidden");alertPopup.classList.remove("flex")}

renderHistory();
</script>
</body>
</html>
