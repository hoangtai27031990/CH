<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>H·ªÜ TH·ªêNG QU·∫¢N L√ù HSD ‚Äì Saigon Co.op</title>

<script src="https://cdn.tailwindcss.com"></script>

<!-- Quagga2: barcode 1D -->
<script src="https://unpkg.com/@ericblade/quagga2/dist/quagga.min.js"></script>

<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<style>
body{background:#f3f4f6}
.card{background:#fff;border-radius:14px;box-shadow:0 4px 16px rgba(0,0,0,.08)}
.brand-bg{background:#c40018}
.brand-text{color:#c40018}

.blink30{animation:blink30 .6s linear infinite;border:2px solid #fb923c}
@keyframes blink30{0%{background:#fff3e0}50%{background:#ff9800;box-shadow:0 0 20px rgba(251,146,60,1)}100%{background:#fff3e0}}

.blink20{animation:blink20 .6s linear infinite;border:2px solid #ef4444}
@keyframes blink20{0%{background:#fff1f2}50%{background:#fecaca;box-shadow:0 0 20px rgba(239,68,68,1)}100%{background:#fff1f2}}

#reader,#printReader{
  width:100%;
  height:220px;
  background:#000;
  border-radius:10px;
  overflow:hidden
}
</style>
</head>

<body class="max-w-xl mx-auto p-3">

<!-- ===== HEADER ===== -->
<div class="flex justify-between items-center mb-4 p-3 rounded-lg brand-bg text-white">
  <div class="font-bold text-lg">H·ªÜ TH·ªêNG QU·∫¢N L√ù HSD</div>
</div>

<!-- ===== MAIN ===== -->
<div class="card p-4 space-y-3">
<label class="font-semibold">Barcode s·∫£n ph·∫©m</label>
<div class="flex gap-2">
<input id="barcode" class="border p-2 rounded w-full">
<button onclick="startScan()" class="brand-bg text-white px-3 rounded">Qu√©t</button>
</div>

<div id="reader" class="hidden mt-2"></div>

<label class="font-semibold">Ng√†y s·∫£n xu·∫•t (NSX)</label>
<input type="date" id="nsx" class="border p-2 rounded w-full">

<label class="font-semibold">H·∫°n s·ª≠ d·ª•ng (HSD)</label>
<input type="date" id="hsd" class="border p-2 rounded w-full">

<div class="grid grid-cols-2 gap-2 pt-2">
<button onclick="calculate()" class="brand-bg text-white py-2 rounded">T√çNH K·∫æT QU·∫¢</button>
<button onclick="resetForm()" class="bg-gray-500 text-white py-2 rounded">T√çNH L·∫†I</button>
</div>

<div id="result"></div>
</div>

<!-- ===== PRINT ===== -->
<div class="card p-4 mt-4">
<h2 class="font-bold brand-text mb-2">In b·∫£ng gi√° qu·∫ßy</h2>

<button onclick="startPrintScan()" class="brand-bg text-white px-3 py-2 rounded mb-2">üì∑ Qu√©t barcode</button>

<div id="printReader" class="hidden mb-2"></div>
<div id="printHistory" class="text-sm"></div>
</div>

<script>
/* =====================
   BI·∫æN & STORAGE
===================== */
const historyKey="coop_hsd_history";
const printKey="coop_print_history";

let scanning=false;
let lastCode="", lastScanTime=0;

/* =====================
   QUAGGA CONFIG
===================== */
function quaggaConfig(target){
  return {
    inputStream:{
      type:"LiveStream",
      target,
      constraints:{
        facingMode:"environment",
        width:{ideal:640},
        height:{ideal:480}
      }
    },
    frequency:6,
    locator:{patchSize:"medium",halfSample:true},
    decoder:{
      readers:["ean_reader","ean_8_reader","code_128_reader","upc_reader"]
    },
    locate:true
  };
}

function validScan(code){
  const now=Date.now();
  if(code===lastCode && now-lastScanTime<1500) return false;
  lastCode=code; lastScanTime=now;
  return true;
}

/* =====================
   SCAN HSD
===================== */
function startScan(){
  if(scanning) return;
  scanning=true;

  const r=document.getElementById("reader");
  r.classList.remove("hidden");

  Quagga.init(quaggaConfig(r),err=>{
    if(err){alert("Kh√¥ng m·ªü ƒë∆∞·ª£c camera"); scanning=false; return;}
    Quagga.start();
  });

  Quagga.onDetected(d=>{
    const code=d.codeResult.code;
    if(!validScan(code)) return;

    barcode.value=code;
    Quagga.stop();
    Quagga.offDetected();
    r.classList.add("hidden");
    scanning=false;
  });
}

/* =====================
   SCAN PRINT
===================== */
function startPrintScan(){
  if(scanning) return;
  scanning=true;

  const r=document.getElementById("printReader");
  r.classList.remove("hidden");

  Quagga.init(quaggaConfig(r),err=>{
    if(err){alert("Kh√¥ng m·ªü ƒë∆∞·ª£c camera"); scanning=false; return;}
    Quagga.start();
  });

  Quagga.onDetected(d=>{
    const code=d.codeResult.code;
    if(!validScan(code)) return;

    addBarcode(code);
    Quagga.stop();
    Quagga.offDetected();
    r.classList.add("hidden");
    scanning=false;
  });
}

/* =====================
   NGHI·ªÜP V·ª§ GI·ªÆ NGUY√äN
===================== */
function calculate(){
  if(!nsx.value||!hsd.value){alert("Nh·∫≠p ƒë·ªß NSX & HSD");return}
  const n=new Date(nsx.value), h=new Date(hsd.value);
  const total=(h-n)/86400000;
  const d30=new Date(n.getTime()+total*0.7*86400000);
  const d20=new Date(n.getTime()+total*0.8*86400000);
  const t=new Date();

  result.innerHTML=`
  <div class="border p-2 ${t>=d30?'blink30':''}">
    M·ªëc 30%: ${d30.toLocaleDateString('vi-VN')}
  </div>
  <div class="border p-2 mt-2 ${t>=d20?'blink20':''}">
    M·ªëc 20%: ${d20.toLocaleDateString('vi-VN')}
  </div>`;
}

function resetForm(){
  barcode.value=""; nsx.value=""; hsd.value=""; result.innerHTML="";
}

function addBarcode(code){
  let d=JSON.parse(localStorage.getItem(printKey)||"{}");
  d[code]=(d[code]||0)+1;
  localStorage.setItem(printKey,JSON.stringify(d));
  printHistory.innerHTML=Object.entries(d).map(([b,q])=>`${b} , ${q}`).join("<br>");
}
</script>

</body>
</html>
