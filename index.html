<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>H·ªÜ TH·ªêNG QU·∫¢N L√ù HSD ‚Äì Saigon Co.op</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<style>
body{background:#f3f4f6}
.card{background:#fff;border-radius:14px;box-shadow:0 4px 16px rgba(0,0,0,.08)}
.brand-bg{background:#c40018}
.brand-text{color:#c40018}

/* BLINK */
.blink30{animation:blink30 .6s linear infinite;border:2px solid #fb923c}
@keyframes blink30{0%{background:#fff3e0}50%{background:#ff9800}100%{background:#fff3e0}}
.blink20{animation:blink20 .6s linear infinite;border:2px solid #ef4444}
@keyframes blink20{0%{background:#fff1f2}50%{background:#fecaca}100%{background:#fff1f2}}

#sidebar{position:fixed;top:0;left:0;width:260px;height:100%;background:#fff;
box-shadow:4px 0 16px rgba(0,0,0,.15);transform:translateX(-100%);
transition:.3s;z-index:1000}
#sidebar.active{transform:translateX(0)}
#overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;z-index:900}
#overlay.active{display:block}

.chat-box{height:420px;overflow:auto;background:#fafafa;border:1px solid #e5e7eb;
border-radius:10px;padding:10px}
.chat-item{background:#fff;border:1px solid #e5e7eb;border-radius:10px;
padding:6px 10px;margin-bottom:6px;font-family:monospace}

.filter-btn{padding:6px 12px;border-radius:6px;border:1px solid #ddd;
background:#f5f5f5;cursor:pointer;font-size:13px}
.filter-btn.active{background:#2563eb;color:white;border-color:#2563eb}

#alertPopup{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:2000}
.popup-30{border:3px solid #fb923c}
.popup-20{border:3px solid #ef4444}
</style>
</head>

<body class="max-w-xl mx-auto p-3">

<!-- POPUP -->
<div id="alertPopup" class="hidden items-center justify-center">
  <div id="popupBox" class="bg-white p-5 rounded-xl w-[90%] max-w-sm text-center">
    <div id="popupTitle" class="font-bold text-lg mb-2"></div>
    <div id="popupMsg" class="mb-4"></div>
    <button onclick="closePopup()" class="brand-bg text-white px-4 py-2 rounded">ƒê√£ hi·ªÉu</button>
  </div>
</div>

<!-- SIDEBAR -->
<div id="sidebar">
  <div class="p-4 border-b text-center">
    <div class="font-bold brand-text">Saigon Co.op</div>
  </div>
  <div class="p-3 space-y-2">
    <button onclick="showMain()" class="w-full text-left px-3 py-2 rounded bg-red-50">
      üì¶ Qu·∫£n l√Ω HSD
    </button>
    <button onclick="showPrint()" class="w-full text-left px-3 py-2 rounded bg-slate-100">
      üñ® In b·∫£ng gi√° qu·∫ßy
    </button>
    <button onclick="showDanhGiaHV()" class="w-full text-left px-3 py-2 rounded bg-slate-100">
      üìù ƒê√°nh gi√° HV
    </button>
  </div>
</div>
<div id="overlay" onclick="toggleMenu()"></div>

<!-- HEADER -->
<div class="flex justify-between items-center mb-4 p-3 rounded-lg brand-bg text-white">
  <div class="font-bold text-lg">H·ªÜ TH·ªêNG QU·∫¢N L√ù HSD</div>
  <button onclick="toggleMenu()" class="text-2xl">‚ò∞</button>
</div>

<!-- ================= MAIN APP ================= -->
<div id="mainApp">

<div class="card p-4 space-y-3">
<label class="font-semibold">Barcode s·∫£n ph·∫©m</label>
<div class="flex gap-2">
<input id="barcode" class="border p-2 rounded w-full">
<button onclick="startScan()" class="brand-bg text-white px-3 rounded">Qu√©t</button>
</div>

<div id="reader" class="hidden"></div>

<label class="font-semibold">Ng√†y s·∫£n xu·∫•t (NSX)</label>
<input type="date" id="nsx" class="border p-2 rounded w-full">

<label class="font-semibold">H·∫°n s·ª≠ d·ª•ng (HSD)</label>
<input type="date" id="hsd" class="border p-2 rounded w-full">

<div class="grid grid-cols-2 gap-2 pt-2">
<button onclick="calculate()" class="brand-bg text-white py-2 rounded">T√çNH K·∫æT QU·∫¢</button>
<button onclick="resetForm()" class="bg-gray-500 text-white py-2 rounded">T√çNH L·∫†I</button>
</div>

<div id="result"></div>

<div class="grid grid-cols-2 gap-2 pt-2">
<button onclick="exportExcel()" class="bg-slate-700 text-white py-2 rounded">Xu·∫•t Excel</button>
<button onclick="clearHistory()" class="bg-red-600 text-white py-2 rounded">X√≥a l·ªãch s·ª≠</button>
</div>

<div id="statistic" class="text-sm pt-2"></div>
</div>

<div class="card p-3 mt-4">
<h2 class="font-bold brand-text mb-2">L·ªãch s·ª≠ t√≠nh to√°n</h2>

<div class="flex gap-2 mb-2">
  <button onclick="setFilter('all')" id="f-all" class="filter-btn active">T·∫•t c·∫£</button>
  <button onclick="setFilter('30')" id="f-30" class="filter-btn">Gi·∫£i t·ªìn (30%)</button>
  <button onclick="setFilter('20')" id="f-20" class="filter-btn">R√∫t h√†ng (20%)</button>
</div>

<div id="history" class="text-sm space-y-1 max-h-64 overflow-auto"></div>
</div>
</div>

<!-- ================= PRINT APP ================= -->
<div id="printApp" class="hidden card p-4">
<h2 class="font-bold brand-text mb-3">In b·∫£ng gi√° qu·∫ßy</h2>

<div class="flex gap-2 mb-2">
<button onclick="startPrintScan()" class="brand-bg text-white px-3 py-2 rounded">üì∑ Qu√©t barcode</button>
<button onclick="exportText()" class="bg-slate-700 text-white px-3 py-2 rounded">‚¨á Xu·∫•t TXT</button>
<button onclick="clearPrintHistory()" class="bg-red-600 text-white px-3 py-2 rounded">üóë X√≥a</button>
</div>

<div id="printReader" class="hidden"></div>
<div class="chat-box" id="printHistory"></div>
</div>

<script>
  function isIOS(){
  return /iPhone|iPad|iPod/i.test(navigator.userAgent);
}

<!-- ================= ƒê√ÅNH GI√Å H·ªåC VI√äN ================= -->
<div id="danhGiaHV" class="hidden card p-4">

<h2 class="font-bold brand-text mb-3 text-center">
PHI·∫æU ƒê√ÅNH GI√Å K·∫æT QU·∫¢ TH·ª∞C T·∫¨P<br>
NH√ÇN VI√äN B√ÅN H√ÄNG CF
</h2>

<div class="grid grid-cols-1 gap-2 mb-3">
  <input id="dg_name" class="border p-2 rounded" placeholder="H·ªç t√™n h·ªçc vi√™n">
  <input id="dg_code" class="border p-2 rounded" placeholder="M√£ h·ªçc vi√™n">
  <input id="dg_date" type="date" class="border p-2 rounded">
  <input id="dg_unit" class="border p-2 rounded" placeholder="ƒê∆°n v·ªã th·ª±c t·∫≠p">
</div>

<div class="grid grid-cols-2 gap-2 mb-3">
  <input id="F22" class="border p-2 rounded" placeholder="F22">
  <input id="F23" class="border p-2 rounded" placeholder="F23">
  <input id="F24" class="border p-2 rounded" placeholder="F24">
  <input id="F25" class="border p-2 rounded" placeholder="F25">
  <input id="F26" class="border p-2 rounded" placeholder="F26">
  <input id="F27" class="border p-2 rounded" placeholder="F27">
  <input id="F28" class="border p-2 rounded" placeholder="F28">
  <input id="F30" class="border p-2 rounded" placeholder="F30">
  <input id="F32" class="border p-2 rounded" placeholder="F32">
  <input id="F34" class="border p-2 rounded" placeholder="F34">
</div>

<button onclick="exportDanhGiaHV()" class="brand-bg text-white w-full py-2 rounded font-semibold">
Xu·∫•t file ƒë√°nh gi√° ƒë·ªÉ in & k√Ω
</button>

</div>

<script>
const sidebar=document.getElementById("sidebar");
const overlay=document.getElementById("overlay");
const mainApp=document.getElementById("mainApp");
const printApp=document.getElementById("printApp");
const danhGiaHV=document.getElementById("danhGiaHV");

function toggleMenu(){sidebar.classList.toggle("active");overlay.classList.toggle("active")}
function showMain(){mainApp.classList.remove("hidden");printApp.classList.add("hidden");danhGiaHV.classList.add("hidden");toggleMenu()}
function showPrint(){mainApp.classList.add("hidden");printApp.classList.remove("hidden");danhGiaHV.classList.add("hidden");toggleMenu()}
function showDanhGiaHV(){mainApp.classList.add("hidden");printApp.classList.add("hidden");danhGiaHV.classList.remove("hidden");toggleMenu()}

async function exportDanhGiaHV(){
  const res = await fetch("Danh_gia_NV_Ban_Hang_CF.xlsx");
  if(!res.ok){alert("Kh√¥ng t√¨m th·∫•y file Excel m·∫´u");return;}

  const buf = await res.arrayBuffer();
  const wb = XLSX.read(buf,{type:"array"});
  const ws = wb.Sheets[wb.SheetNames[0]];

  ws["F5"]={t:"s",v:dg_name.value};
  ws["F6"]={t:"s",v:dg_code.value};
  ws["F7"]={t:"s",v:dg_date.value};
  ws["F8"]={t:"s",v:dg_unit.value};

  ["F22","F23","F24","F25","F26","F27","F28","F30","F32","F34"]
  .forEach(c=>ws[c]={t:"n",v:Number(document.getElementById(c).value||0)});

  XLSX.writeFile(wb,"Danh_gia_NV_Ban_Hang_CF_DA_DIEN.xlsx");
  showPopup("export");
}

function showPopup(){
  alertPopup.classList.remove("hidden");
  alertPopup.classList.add("flex");
  popupTitle.innerText="Xu·∫•t file th√†nh c√¥ng";
  popupMsg.innerText="File ƒë√£ s·∫µn s√†ng ƒë·ªÉ in v√† k√Ω tay";
}

function closePopup(){
  alertPopup.classList.add("hidden");
  alertPopup.classList.remove("flex");
}
</script>

</body>
</html>
