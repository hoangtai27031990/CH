
<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>H·ªÜ TH·ªêNG QU·∫¢N L√ù HSD ‚Äì Saigon Co.op</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<style>
body{background:#f3f4f6}
.card{background:#fff;border-radius:14px;box-shadow:0 4px 16px rgba(0,0,0,.08)}
.brand-bg{background:#c40018}
.brand-text{color:#c40018}

/* ===== BLINK ===== */
.blink30{animation:blink30 .6s linear infinite;border:2px solid #fb923c}
@keyframes blink30{0%{background:#fff3e0}50%{background:#ff9800}100%{background:#fff3e0}}
.blink20{animation:blink20 .6s linear infinite;border:2px solid #ef4444}
@keyframes blink20{0%{background:#fff1f2}50%{background:#fecaca}100%{background:#fff1f2}}

#sidebar{position:fixed;top:0;left:0;width:260px;height:100%;background:#fff;box-shadow:4px 0 16px rgba(0,0,0,.15);transform:translateX(-100%);transition:.3s;z-index:1000}
#sidebar.active{transform:translateX(0)}
#overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;z-index:900}
#overlay.active{display:block}

.chat-box{height:420px;overflow:auto;background:#fafafa;border:1px solid #e5e7eb;border-radius:10px;padding:10px}
.chat-item{background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:6px 10px;margin-bottom:6px;font-family:monospace}

.filter-btn{padding:6px 12px;border-radius:6px;border:1px solid #ddd;background:#f5f5f5;cursor:pointer;font-size:13px}
.filter-btn.active{background:#2563eb;color:white;border-color:#2563eb}

/* ===== POPUP ===== */
#alertPopup{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:2000}
.popup-30{border:3px solid #fb923c}
.popup-20{border:3px solid #ef4444}

/* ===== SCAN OVERLAY ===== */
#reader,#printReader{
  position:relative;
  width:100%;
  height:260px;
  background:#000;
}
.scan-frame{
  position:absolute;
  inset:10%;
  border:2px solid rgba(255,255,255,.4);
  z-index:10;
}
.scan-line{
  position:absolute;
  left:5%;
  width:90%;
  height:4px;
  background:red;
  box-shadow:0 0 12px red;
  animation:scanMove 1.2s linear infinite;
  z-index:20;
}
@keyframes scanMove{
  0%{top:30%}
  50%{top:50%}
  100%{top:70%}
}
  /* ================= PULSE POPUP ================= */

/* Pulse m√†u cam ‚Äì m·ªëc 30% */
@keyframes pulseOrange {
  0% {
    box-shadow: 0 0 0 0 rgba(251,146,60,0.45);
  }
  70% {
    box-shadow: 0 0 0 16px rgba(251,146,60,0);
  }
  100% {
    box-shadow: 0 0 0 0 rgba(251,146,60,0);
  }
}

/* Pulse m√†u ƒë·ªè ‚Äì m·ªëc 20% */
@keyframes pulseRed {
  0% {
    box-shadow: 0 0 0 0 rgba(239,68,68,0.5);
  }
  70% {
    box-shadow: 0 0 0 20px rgba(239,68,68,0);
  }
  100% {
    box-shadow: 0 0 0 0 rgba(239,68,68,0);
  }
}

/* Class √°p d·ª•ng */
.popup-pulse-30 {
  border: 3px solid #fb923c;
  animation: pulseOrange 1.4s infinite;
}

.popup-pulse-20 {
  border: 3px solid #ef4444;
  animation: pulseRed 0.9s infinite;
}
  @keyframes pulseCheck {
  0% { box-shadow: 0 0 0 0 rgba(239,68,68,0.5); }
  70% { box-shadow: 0 0 0 25px rgba(239,68,68,0); }
  100% { box-shadow: 0 0 0 0 rgba(239,68,68,0); }
}

/* ================= CHECK DATE PULSE ================= */

@keyframes checkDatePulse {
  0% {
    transform: scale(1);
    box-shadow: 0 0 0 0 rgba(220,38,38,0.45);
  }
  60% {
    transform: scale(1.02);
    box-shadow: 0 0 0 20px rgba(220,38,38,0);
  }
  100% {
    transform: scale(1);
    box-shadow: 0 0 0 0 rgba(220,38,38,0);
  }
}

.checkdate-pulse {
  border: 3px solid #dc2626;
  animation: checkDatePulse 1.5s ease-out infinite;
}
.toast{
  position: fixed;
  right: 20px;
  bottom: 20px;
  background: #2e7d32;
  color: white;
  padding: 12px 18px;
  border-radius: 8px;
  font-size: 14px;
  opacity: 0;
  transform: translateY(20px);
  transition: all 0.3s ease;
  z-index: 9999;
  pointer-events: none;
}

.toast.show{
  opacity: 1;
  transform: translateY(0);
}
</style>
</head>

<body class="max-w-xl mx-auto p-3">

<!-- POPUP -->
<div id="alertPopup" class="hidden items-center justify-center">
  <div id="popupBox" class="bg-white p-5 rounded-xl w-[90%] max-w-sm text-center">
    <div id="popupTitle" class="font-bold text-lg mb-2"></div>
    <div id="popupMsg" class="mb-4"></div>
    <button onclick="closePopup()" class="brand-bg text-white px-4 py-2 rounded">ƒê√£ hi·ªÉu</button>
  </div>
</div>
<!-- POPUP KI·ªÇM DATE -->
<div id="checkDateBox"
     class="fixed inset-0 hidden items-center justify-center bg-black bg-opacity-50 z-[2100]">

<div id="checkDateInner"
     class="bg-white p-5 rounded-xl w-[95%] max-w-md text-center">

    <div class="font-bold text-lg mb-3 text-red-600">
      S·∫¢N PH·∫®M C·∫¶N KI·ªÇM DATE
    </div>

    <div id="checkDateList"
         class="text-left space-y-3 max-h-80 overflow-auto">
    </div>

    <div class="mt-4">
      <button onclick="closeCheckDatePopup()"
        class="bg-gray-600 text-white px-4 py-2 rounded">
        ƒê√É HI·ªÇU
      </button>
    </div>

  </div>
</div>

<!-- SIDEBAR -->
<div id="sidebar">
  <div class="p-4 border-b text-center">
    <div class="font-bold brand-text">Saigon Co.op</div>
  </div>
  <div class="p-3 space-y-2">
    <button onclick="showMain()" class="w-full text-left px-3 py-2 rounded bg-red-50">üì¶ Qu·∫£n l√Ω HSD</button>
    <button onclick="showPrint()" class="w-full text-left px-3 py-2 rounded bg-slate-100">üñ® In b·∫£ng gi√° qu·∫ßy</button>
  </div>
</div>
<div id="overlay" onclick="toggleMenu()"></div>

<!-- HEADER -->
<div class="flex justify-between items-center mb-4 p-3 rounded-lg brand-bg text-white">
  <div class="font-bold text-lg">H·ªÜ TH·ªêNG QU·∫¢N L√ù HSD</div>
  <button onclick="toggleMenu()" class="text-2xl">‚ò∞</button>
</div>

<!-- ================= MAIN APP ================= -->
<div id="mainApp">

<div class="card p-4 space-y-3">
<label class="font-semibold">T√™n s·∫£n ph·∫©m (N√™n nh·∫≠p ƒë·ªÉ d·ªÖ ki·ªÉm so√°t)</label>
<input id="productName" class="border p-2 rounded w-full" placeholder="V√≠ d·ª•: S·ªØa t∆∞∆°i Vinamilk 1L">
<label class="font-semibold">Barcode s·∫£n ph·∫©m</label>
<div class="flex gap-2">
<input id="barcode" class="border p-2 rounded w-full">
<button onclick="startScan()" class="brand-bg text-white px-3 rounded">Qu√©t</button>
</div>

<div id="reader" class="hidden"></div>
<label class="font-semibold">Ch·ªçn lo·∫°i t√≠nh</label>
<select id="calcMode" class="border p-2 rounded w-full" onchange="changeCalcMode()">
  <option value="full">C√≥ NSX & HSD</option>
  <option value="hsdBack">Ch·ªâ c√≥ H·∫†N S·ª¨ D·ª§NG</option>
  <option value="nsxPeriod">Ch·ªâ c√≥ NG√ÄY S·∫¢N XU·∫§T</option>
</select>

<div id="nsxBlock">
  <label class="font-semibold">Ng√†y s·∫£n xu·∫•t (NSX)</label>
  <input type="date" id="nsx" class="border p-2 rounded w-full">
</div>

<div id="hsdBlock">
  <label class="font-semibold">H·∫°n s·ª≠ d·ª•ng (HSD)</label>
  <input type="date" id="hsd" class="border p-2 rounded w-full">
</div>
<!-- Th·ªùi gian tr∆∞·ªõc HSD -->
<div id="beforeHsdBlock" class="hidden">
  <label class="font-semibold">Th·ªùi gian tr∆∞·ªõc HSD</label>
  <div class="flex gap-2">
    <input type="number" id="beforeHsdValue" class="border p-2 rounded w-1/2" placeholder="V√≠ d·ª•: 6">
    <select id="beforeHsdUnit" class="border p-2 rounded w-1/2">
      <option value="day">Ng√†y</option>
      <option value="month">Th√°ng</option>
      <option value="year">NƒÉm</option>
    </select>
  </div>
</div>

<!-- Th·ªùi gian s·ª≠ d·ª•ng t·ª´ NSX -->
<div id="nsxPeriodBlock" class="hidden">
  <label class="font-semibold">Th·ªùi gian s·ª≠ d·ª•ng t·ª´ NSX</label>
  <div class="flex gap-2">
    <input type="number" id="periodValue" class="border p-2 rounded w-1/2" placeholder="V√≠ d·ª•: 6">
    <select id="periodUnit" class="border p-2 rounded w-1/2">
      <option value="day">Ng√†y</option>
      <option value="month">Th√°ng</option>
      <option value="year">NƒÉm</option>
    </select>
  </div>
</div>

<div class="grid grid-cols-2 gap-2 pt-2">
<button onclick="calculate()" class="brand-bg text-white py-2 rounded">T√çNH K·∫æT QU·∫¢</button>
<button onclick="resetForm()" class="bg-gray-500 text-white py-2 rounded">T√çNH L·∫†I</button>
</div>

<div id="result"></div>

<div class="grid grid-cols-2 gap-2 pt-2">
<button onclick="exportExcel()" class="bg-slate-700 text-white py-2 rounded">Xu·∫•t Excel</button>
<button onclick="clearHistory()" class="bg-red-600 text-white py-2 rounded">X√≥a l·ªãch s·ª≠</button>
</div>

<div id="statistic" class="text-sm pt-2"></div>
</div>

<div class="card p-3 mt-4">
  <h2 class="font-bold brand-text mb-2">Th·ªëng k√™</h2>
  <div id="statistic" class="text-sm"></div>
</div>

<!-- ================= PRINT APP ================= -->
<div id="printApp" class="hidden card p-4">
<h2 class="font-bold brand-text mb-3">In b·∫£ng gi√° qu·∫ßy</h2>

<div class="flex gap-2 mb-2">
<button onclick="startPrintScan()" class="brand-bg text-white px-3 py-2 rounded">üì∑ Qu√©t barcode</button>
<button onclick="exportText()" class="bg-slate-700 text-white px-3 py-2 rounded">‚¨á Xu·∫•t TXT</button>
<button onclick="clearPrintHistory()" class="bg-red-600 text-white px-3 py-2 rounded">üóë X√≥a</button>
</div>

<div id="printReader" class="hidden"></div>
<div class="chat-box" id="printHistory"></div>
</div>

<script>
  function isIOS(){
  return /iPhone|iPad|iPod/i.test(navigator.userAgent);
}
/* ================= CORE ================= */
const historyKey="coop_hsd_history";
  /* ================= AUTO CLEAN EXPIRED ================= */
function autoCleanExpired(){

  let data = JSON.parse(localStorage.getItem(historyKey) || "[]");
  if(!data.length) return;

  const today = new Date();
  today.setHours(0,0,0,0);

  const filtered = data.filter(item => {

    if(!item.HSD) return true;

    const hsd = new Date(item.HSD);

    if(isNaN(hsd)) return true;

    hsd.setHours(0,0,0,0);

    // ‚ùå X√ìA n·∫øu ƒë√£ qua ng√†y h√¥m nay
    if(hsd < today){
      return false;
    }

    return true;
  });

  if(filtered.length !== data.length){
    localStorage.setItem(historyKey, JSON.stringify(filtered));
  }
}

const printKey="coop_print_history";

const sidebar=document.getElementById("sidebar");
const overlay=document.getElementById("overlay");
const mainApp=document.getElementById("mainApp");
const printApp=document.getElementById("printApp");
  const statistic = document.getElementById("statistic");
const result = document.getElementById("result");
const printHistory = document.getElementById("printHistory");


function toggleMenu(){sidebar.classList.toggle("active");overlay.classList.toggle("active")}
function stopAllScanner(){
  if(qr){
    qr.stop().then(()=>qr.clear()).catch(()=>{});
    qr = null;
  }
  isScanning = false;
  scanMode = null;
}

  
function showMain(){
  stopAllScanner();
  mainApp.classList.remove("hidden");
  printApp.classList.add("hidden");
  toggleMenu();
}

function showPrint(){
  stopAllScanner();
  mainApp.classList.add("hidden");
  printApp.classList.remove("hidden");
  toggleMenu();
}

function changeCalcMode(){
  const m = calcMode.value;

  nsxBlock.classList.add("hidden");
  hsdBlock.classList.add("hidden");
  beforeHsdBlock.classList.add("hidden");
  nsxPeriodBlock.classList.add("hidden");

  if(m === "full"){
    nsxBlock.classList.remove("hidden");
    hsdBlock.classList.remove("hidden");
  }

  if(m === "hsdBack"){
    hsdBlock.classList.remove("hidden");
    beforeHsdBlock.classList.remove("hidden");
  }

  if(m === "nsxPeriod"){
    nsxBlock.classList.remove("hidden");
    nsxPeriodBlock.classList.remove("hidden");
  }
}

/* ================= SCAN CONFIG ================= */
const scanConfigAndroidWeak = { fps: 10, qrbox: 250 };

let qr = null;
let currentFilter = "all";
let scanMode = null; // main | print
let isScanning = false;
let isPopupShowing = false;

/* ================= SCAN MAIN ================= */
async function startScan(){

  if(isIOS()){
    alert("‚ö†Ô∏è iPhone kh√¥ng h·ªó tr·ª£ qu√©t barcode.\nVui l√≤ng nh·∫≠p tay.");
    return;
  }

  if(isScanning) return;
  isScanning = true;
  scanMode = "main";

  stopAllScanner();

  const r = document.getElementById("reader");
  r.innerHTML = `
    <div class="scan-frame">
      <div class="scan-line"></div>
    </div>
  `;
  r.classList.remove("hidden");

  qr = new Html5Qrcode("reader");

  qr.start(
    { facingMode: "environment" },
    scanConfigAndroidWeak,
    code => {
      handleScanResult(code);
    },
    () => {}
  ).catch(()=>{
    isScanning = false;
    r.classList.add("hidden");
  });
}


/* ================= SCAN PRINT ================= */
async function startPrintScan(){

  if(isIOS()){
    alert("‚ö†Ô∏è Thi·∫øt b·ªã iOS kh√¥ng h·ªó tr·ª£ qu√©t barcode.");
    return;
  }

  if(isScanning) return;
  isScanning = true;
  scanMode = "print";

  stopAllScanner();

  const r = document.getElementById("printReader");
  r.innerHTML = `
    <div class="scan-frame">
      <div class="scan-line"></div>
    </div>
  `;
  r.classList.remove("hidden");

  qr = new Html5Qrcode("printReader");

  qr.start(
    { facingMode: "environment" },
    scanConfigAndroidWeak,
    code => {
      handleScanResult(code);
    }
  ).catch(()=>{
    isScanning = false;
    r.classList.add("hidden");
  });
}
function handleScanResult(code){

  if(scanMode === "main"){
    barcode.value = code;
    document.getElementById("reader").classList.add("hidden");
  }

  if(scanMode === "print"){
    addBarcode(code);
    document.getElementById("printReader").classList.add("hidden");
  }

  if(qr){
    qr.stop().then(()=>{
      qr.clear();
      qr = null;
      isScanning = false;
      scanMode = null;
    }).catch(()=>{});
  }
}


function addPeriod(date, value, unit){
  const d = new Date(date);

  if(unit === "day") d.setDate(d.getDate() + value);

  if(unit === "month"){
    const day = d.getDate();
    d.setMonth(d.getMonth() + value);
    if(d.getDate() < day) d.setDate(0);
  }

  if(unit === "year") d.setFullYear(d.getFullYear() + value);

  return d;
}

function calculate(){
let nsxD, hsdD;
const mode = calcMode.value;

if(mode === "full"){
  if(!nsx.value || !hsd.value){
    alert("Nh·∫≠p ƒë·ªß NSX & HSD"); return;
  }
  nsxD = new Date(nsx.value);
  hsdD = new Date(hsd.value);
}

if(mode === "hsdBack"){
  if(!hsd.value){
    alert("Nh·∫≠p HSD"); return;
  }
  const v = Number(beforeHsdValue.value);
  const u = beforeHsdUnit.value;
  if(!v){
    alert("Nh·∫≠p th·ªùi gian tr∆∞·ªõc HSD"); return;
  }
  hsdD = new Date(hsd.value);
  nsxD = addPeriod(hsdD, -v, u);
}

if(mode === "nsxPeriod"){
  if(!nsx.value){
    alert("Nh·∫≠p NSX"); return;
  }
  const v = Number(periodValue.value);
  const u = periodUnit.value;
  if(!v){
    alert("Nh·∫≠p th·ªùi gian s·ª≠ d·ª•ng"); return;
  }
  nsxD = new Date(nsx.value);
  hsdD = addPeriod(nsxD, v, u);
}

if(hsdD <= nsxD){
  alert("HSD ph·∫£i l·ªõn h∆°n NSX"); return;
}

 const total=(hsdD-nsxD)/86400000;
 const date30=new Date(nsxD.getTime()+total*0.7*86400000);
 const date20=new Date(nsxD.getTime()+total*0.8*86400000);
 const today=new Date();

 let warn30="",warn20="",b30="",b20="",f30="B√¨nh th∆∞·ªùng",f20="B√¨nh th∆∞·ªùng";

 if(today>=date30){warn30="‚ö†Ô∏è <b>B√°o c√°o Qu·∫£n l√Ω gi·∫£i t·ªìn</b>";b30="blink30";f30="Gi·∫£i t·ªìn"}
 if(today>=date20){warn20="‚ö†Ô∏è <b>R√∫t h√†ng kh·ªèi qu·∫ßy</b>";b20="blink20";f20="R√∫t h√†ng"}

 result.innerHTML=`
<div class="border p-3 mb-3 ${b30}">
<b>M·ªêC 30%</b><br>üìÖ ${date30.toLocaleDateString("vi-VN")}
<div>${warn30||"<span class='text-green-700'>Trong ng∆∞·ª°ng an to√†n</span>"}</div>
</div>

<div class="border p-3 ${b20}">
<b>M·ªêC 20%</b><br>üìÖ ${date20.toLocaleDateString("vi-VN")}
<div>${warn20||"<span class='text-green-700'>Trong ng∆∞·ª°ng an to√†n</span>"}</div>
</div>`;

saveHistory(nsxD, hsdD, date30, date20, f30, f20);
autoCleanExpired();

 if(today>=date20) showPopup("20");
 else if(today>=date30) showPopup("30");
}

function saveHistory(nsxD, hsdD, date30, date20, f30, f20){

   const history = JSON.parse(localStorage.getItem(historyKey)) || [];

   const record = {
      id: Date.now() + Math.random(),
      TenSP: productName.value.trim() || "",
      Barcode: barcode.value.trim() || "",
      NSX: nsxD.toISOString(),
      HSD: hsdD.toISOString(),
      M30: date30.toISOString(),
      M20: date20.toISOString(),
      CanhBao30: f30,
      CanhBao20: f20,
      ThoiGian: new Date().toLocaleString("vi-VN")
   };

   history.unshift(record);

   localStorage.setItem(historyKey, JSON.stringify(history));

   renderHistory();
}


function setFilter(type){
 currentFilter=type;
 document.querySelectorAll(".filter-btn").forEach(b=>b.classList.remove("active"));
 document.getElementById("f-"+type).classList.add("active");
 renderHistory();
}

function renderHistory(){

  let data = JSON.parse(localStorage.getItem(historyKey) || "[]");

  if(!Array.isArray(data)){
    statistic.innerHTML = "üì¶ T·ªïng: 0";
    return;
  }

  statistic.innerHTML = `üì¶ T·ªïng: <b>${data.length}</b>`;
}


function clearHistory(){

  const data = JSON.parse(localStorage.getItem(historyKey) || "[]");

  if(!data.length){
    alert("Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ x√≥a");
    return;
  }

  document.getElementById("confirmBox").classList.remove("hidden");
  document.getElementById("confirmBox").classList.add("flex");
}
function confirmDeleteHistory(){

  localStorage.removeItem(historyKey);
  renderHistory();
  closeConfirmPopup();
}

function closeConfirmPopup(){
  const box = document.getElementById("confirmBox");
  box.classList.add("hidden");
  box.classList.remove("flex");
}

function exportExcel(){

  const h = JSON.parse(localStorage.getItem(historyKey) || "[]");

  if(!h.length){
    alert("Kh√¥ng c√≥ d·ªØ li·ªáu");
    return;
  }

  // Chu·∫©n h√≥a d·ªØ li·ªáu khi xu·∫•t (ƒë·ªãnh d·∫°ng ng√†y d·ªÖ ƒë·ªçc)
  const exportData = h.map(x => ({
    "T√™n SP": x.TenSP || "",
    "Barcode": x.Barcode || "",
    "NSX": new Date(x.NSX).toLocaleDateString("vi-VN"),
    "HSD": new Date(x.HSD).toLocaleDateString("vi-VN"),
    "M·ªëc 30%": new Date(x.M30).toLocaleDateString("vi-VN"),
    "M·ªëc 20%": new Date(x.M20).toLocaleDateString("vi-VN"),
    "Tr·∫°ng th√°i 30%": x.CanhBao30,
    "Tr·∫°ng th√°i 20%": x.CanhBao20,
    "Th·ªùi gian t√≠nh": x.ThoiGian,
    "ƒê√£ ki·ªÉm date": x.completed ? "ƒê√£ x·ª≠ l√Ω" : "Ch∆∞a x·ª≠ l√Ω"
  }));

  const ws = XLSX.utils.json_to_sheet(exportData);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "HSD");

  XLSX.writeFile(wb, "saigoncoop_hsd.xlsx");

  // ‚ùå KH√îNG x√≥a localStorage n·ªØa
  // localStorage.removeItem(historyKey);

  showPopup("export");
}


autoCleanExpired();   // TH√äM D√íNG N√ÄY

renderHistory();
renderPrint();
checkStoredProducts();

function addBarcode(code){
 let d=JSON.parse(localStorage.getItem(printKey)||"{}");
 d[code]=(d[code]||0)+1;
 localStorage.setItem(printKey,JSON.stringify(d));
 renderPrint();
}

function renderPrint(){
 const d=JSON.parse(localStorage.getItem(printKey)||"{}");
 printHistory.innerHTML=Object.entries(d).map(([b,q])=>`<div class="chat-item">${b},${q}</div>`).join("");
}

function clearPrintHistory(){localStorage.removeItem(printKey);renderPrint()}

function exportText(){
 const d=JSON.parse(localStorage.getItem(printKey)||"{}");
 if(!Object.keys(d).length){alert("Kh√¥ng c√≥ d·ªØ li·ªáu");return}

 const txt=Object.entries(d).map(([b,q])=>`${b},${q}`).join("\n");
 const blob=new Blob([txt],{type:"text/plain;charset=utf-8"});
 const url=URL.createObjectURL(blob);
 const a=document.createElement("a");
 a.href=url;a.download="barcode_print.txt";
 document.body.appendChild(a);a.click();document.body.removeChild(a);
 URL.revokeObjectURL(url);
  
 localStorage.removeItem(printKey);
 renderPrint();
 showPopup("export");
}

function showPopup(type){

 if(isPopupShowing) return; // ch·∫∑n m·ªü ch·ªìng
 isPopupShowing = true;

 const popup = document.getElementById("alertPopup");
 const box = document.getElementById("popupBox");
 const title = document.getElementById("popupTitle");
 const msg = document.getElementById("popupMsg");

 // reset class tr∆∞·ªõc khi th√™m hi·ªáu ·ª©ng m·ªõi
 box.className = "bg-white p-5 rounded-xl w-[90%] max-w-sm text-center";

 // ∆Øu ti√™n 20% tr∆∞·ªõc
 if(type === "20"){
  title.innerText = "C·∫¢NH B√ÅO M·ªêC 20%";
  msg.innerText = "R√∫t h√†ng kh·ªèi qu·∫ßy ngay.";
  box.classList.add("popup-pulse-20");
 }

 else if(type === "30"){
  title.innerText = "C·∫¢NH B√ÅO M·ªêC 30%";
  msg.innerText = "B√°o c√°o qu·∫£n l√Ω ƒë·ªÉ th·ª±c hi·ªán gi·∫£i t·ªìn.";
  box.classList.add("popup-pulse-30");
 }

 else if(type === "export"){
  title.innerText = "XU·∫§T FILE TH√ÄNH C√îNG";
  msg.innerText = "D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c t·∫£i v·ªÅ v√† h·ªá th·ªëng ƒë√£ s·∫µn s√†ng cho l·∫ßn ti·∫øp theo.";
 }

 popup.classList.remove("hidden");
 popup.classList.add("flex");

 if(type === "export"){
   setTimeout(closePopup, 2500);
 }
}


function closePopup(){
 const popup = document.getElementById("alertPopup");
 popup.classList.add("hidden");
 popup.classList.remove("flex");
 isPopupShowing = false;
}

  
function resetForm(){
  productName.value="";
  barcode.value="";
  nsx.value="";
  hsd.value="";
  beforeHsdValue.value="";
  periodValue.value="";
  result.innerHTML="";
}
function checkStoredProducts(){
if(isPopupShowing) return;
 let data = JSON.parse(localStorage.getItem(historyKey) || "[]");

 if(!Array.isArray(data) || !data.length){
   closeCheckDatePopup();
   return;
 }

 const today = new Date();
 today.setHours(0,0,0,0);

 function parseVNDate(dateStr){
   if(!dateStr) return null;
   if(dateStr.includes("-")) return new Date(dateStr);
   const [d,m,y] = dateStr.split("/");
   return new Date(`${y}-${m}-${d}`);
 }

 let warningProducts = [];

 data.forEach(item => {

   if(item.completed === true) return;

   const m30 = new Date(item.M30);
   if(!m30 || isNaN(m30)) return;

   m30.setHours(0,0,0,0);

   const before15 = new Date(m30);
   before15.setDate(before15.getDate() - 15);

   const after10 = new Date(m30);
   after10.setDate(after10.getDate() + 10);

   if(today >= before15 && today <= after10){
     warningProducts.push(item);
   }

 });

 if(warningProducts.length){
   showCheckDatePopup(warningProducts);
 } else {
   closeCheckDatePopup();
 }
}


function showCheckDatePopup(list){

 isPopupShowing = true;
 const box = document.getElementById("checkDateBox");
 const container = document.getElementById("checkDateList");
const inner = document.getElementById("checkDateInner");
inner.classList.remove("checkdate-pulse");

 if(!list || !list.length){
   closeCheckDatePopup();
   return;
 }

 container.innerHTML = list.map(item => {

   const m30 = new Date(item.M30).toLocaleDateString("vi-VN");
   const hsd = new Date(item.HSD).toLocaleDateString("vi-VN");

   return `
   <div class="border p-2 rounded">
     <div><b>${item.TenSP || "-"}</b></div>
     <div>Ng∆∞·ª°ng 30%: ${m30}</div>
     <div>HSD: ${hsd}</div>
     <button onclick="completeProduct(${item.id})"
       class="mt-2 bg-red-600 text-white px-3 py-1 rounded text-sm">
       HO√ÄN TH√ÄNH
     </button>
   </div>`;
 }).join("");
  
inner.classList.add("checkdate-pulse");

 box.classList.remove("hidden");
 box.classList.add("flex");
}



function completeProduct(id){

  let data = JSON.parse(localStorage.getItem(historyKey) || "[]");

  // ƒê√°nh d·∫•u ho√†n th√†nh
  data = data.map(item => {
    if(item.id === id){
      return { ...item, completed: true };
    }
    return item;
  });

  localStorage.setItem(historyKey, JSON.stringify(data));

  // L·ªçc l·∫°i danh s√°ch c·∫£nh b√°o t·ª´ d·ªØ li·ªáu m·ªõi
  const today = new Date();
  today.setHours(0,0,0,0);

  const warningProducts = data.filter(item => {

    if(item.completed) return false;

    const m30 = new Date(item.M30);
    if(isNaN(m30)) return false;

    m30.setHours(0,0,0,0);

    const before15 = new Date(m30);
    before15.setDate(before15.getDate() - 15);

    const after10 = new Date(m30);
    after10.setDate(after10.getDate() + 10);

    return today >= before15 && today <= after10;
  });

  // Render l·∫°i popup ƒë√∫ng d·ªØ li·ªáu m·ªõi
  if(warningProducts.length > 0){
    showCheckDatePopup(warningProducts);
  } else {
    closeCheckDatePopup();
  }

 autoCleanExpired();
renderHistory();
showToast("ƒê√£ x·ª≠ l√Ω s·∫£n ph·∫©m");
}

function closeCheckDatePopup(){
  const box = document.getElementById("checkDateBox");
  const inner = document.getElementById("checkDateInner");

  inner.classList.remove("checkdate-pulse");

  box.classList.add("hidden");
  box.classList.remove("flex");
  isPopupShowing = false;
}
function showToast(message = "ƒê√£ x·ª≠ l√Ω"){

  const toast = document.getElementById("toastBox");
  toast.innerText = message;

  toast.classList.add("show");

  setTimeout(() => {
    toast.classList.remove("show");
  }, 2500);
}
</script>
<div id="confirmBox"
     class="fixed inset-0 hidden items-center justify-center bg-black bg-opacity-50 z-[2200]">

  <div class="bg-white p-5 rounded-xl w-[90%] max-w-sm text-center">
    <div class="font-bold text-lg mb-3 text-red-600">
      X√ÅC NH·∫¨N X√ìA L·ªäCH S·ª¨
    </div>

    <div class="mb-4 text-sm">
      Thao t√°c n√†y s·∫Ω x√≥a to√†n b·ªô d·ªØ li·ªáu v√† kh√¥ng th·ªÉ kh√¥i ph·ª•c.
    </div>

    <div class="flex justify-center gap-3">
      <button onclick="confirmDeleteHistory()"
        class="bg-red-600 text-white px-4 py-2 rounded">
        X√ìA
      </button>

      <button onclick="closeConfirmPopup()"
        class="bg-gray-500 text-white px-4 py-2 rounded">
        H·ª¶Y
      </button>
    </div>
  </div>
</div>
<div id="toastBox" class="toast"></div>
</body>
</html>
