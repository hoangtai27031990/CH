<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>H·ªÜ TH·ªêNG QU·∫¢N L√ù HSD ‚Äì Saigon Co.op</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<style>
body{background:#f3f4f6}
.card{background:#fff;border-radius:14px;box-shadow:0 4px 16px rgba(0,0,0,.08)}
.brand-bg{background:#c40018}
.brand-text{color:#c40018}
.warning20{color:#b91c1c;font-weight:700}
.warning30{color:#c2410c;font-weight:700}

/* 30% blink m·∫°nh ‚Äì cam ƒë·∫≠m */
.blink30{
  animation: blink30 .6s linear infinite;
  border:2px solid #fb923c;
}
@keyframes blink30{
  0%{background:#fff3e0}
  50%{background:#ff9800;box-shadow:0 0 20px rgba(251,146,60,1)}
  100%{background:#fff3e0}
}

/* 20% blink m·∫°nh ‚Äì ƒë·ªè nh·∫°t */
.blink20{
  animation: blink20 .6s linear infinite;
  border:2px solid #ef4444;
}
@keyframes blink20{
  0%{background:#fff1f2}
  50%{background:#fecaca;box-shadow:0 0 20px rgba(239,68,68,1)}
  100%{background:#fff1f2}
}

/* sidebar */
#sidebar{
  position:fixed;top:0;left:0;width:260px;height:100%;
  background:#fff;box-shadow:4px 0 16px rgba(0,0,0,.15);
  transform:translateX(-100%);transition:.3s;z-index:1000
}
#sidebar.active{transform:translateX(0)}
#overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.4);
  display:none;z-index:900
}
#overlay.active{display:block}

/* chat style */
.chat-box{
  height:420px;overflow:auto;background:#fafafa;
  border:1px solid #e5e7eb;border-radius:10px;padding:10px
}
.chat-item{
  background:#fff;border:1px solid #e5e7eb;border-radius:10px;
  padding:6px 10px;margin-bottom:6px;font-family:monospace
}
</style>
</head>

<body class="max-w-xl mx-auto p-3">

<!-- Sidebar -->
<div id="sidebar">
  <div class="p-4 border-b text-center">
    <img src="https://upload.wikimedia.org/wikipedia/vi/3/3f/Saigon_Co.op_logo.png" class="mx-auto mb-2" width="140">
    <div class="font-bold brand-text">Saigon Co.op</div>
  </div>
  <div class="p-3 space-y-2">
    <button onclick="showMain()" class="w-full text-left px-3 py-2 rounded bg-red-50">üì¶ Qu·∫£n l√Ω HSD</button>
    <button onclick="showPrint()" class="w-full text-left px-3 py-2 rounded bg-slate-100">üñ® In b·∫£ng gi√° qu·∫ßy</button>
  </div>
</div>
<div id="overlay" onclick="toggleMenu()"></div>

<!-- Header -->
<div class="flex justify-between items-center mb-4 p-3 rounded-lg brand-bg text-white">
  <div>
    <div class="font-bold text-lg">H·ªÜ TH·ªêNG QU·∫¢N L√ù HSD</div>
    <div class="text-sm opacity-90">Saigon Co.op</div>
  </div>
  <button onclick="toggleMenu()" class="text-2xl">‚ò∞</button>
</div>

<!-- TAB HSD -->
<div id="mainApp">

<div class="card p-4 space-y-3">
<label class="font-semibold">Barcode s·∫£n ph·∫©m</label>
<div class="flex gap-2">
<input id="barcode" class="border p-2 rounded w-full">
<button onclick="startScan()" class="brand-bg text-white px-3 rounded">Qu√©t</button>
</div>

<div id="reader" class="hidden mt-2"></div>

<label class="font-semibold">Ng√†y s·∫£n xu·∫•t (NSX)</label>
<input type="date" id="nsx" class="border p-2 rounded w-full">

<label class="font-semibold">H·∫°n s·ª≠ d·ª•ng (HSD)</label>
<input type="date" id="hsd" class="border p-2 rounded w-full">

<div class="grid grid-cols-2 gap-2 pt-2">
<button onclick="calculate()" class="brand-bg text-white py-2 rounded font-semibold">T√çNH K·∫æT QU·∫¢</button>
<button onclick="resetForm()" class="bg-gray-500 text-white py-2 rounded font-semibold">T√çNH L·∫†I</button>
</div>

<div id="result" class="pt-2"></div>

<div class="grid grid-cols-2 gap-2 pt-2">
<button onclick="exportExcel()" class="bg-slate-700 text-white py-2 rounded">Xu·∫•t Excel</button>
<button onclick="clearHistory()" class="bg-red-600 text-white py-2 rounded">X√≥a l·ªãch s·ª≠</button>
</div>

<div id="statistic" class="text-sm pt-2"></div>
</div>

<div class="card p-3 mt-4">
<h2 class="font-bold brand-text mb-2">L·ªãch s·ª≠ t√≠nh to√°n</h2>
<div id="history" class="text-sm space-y-1 max-h-64 overflow-auto"></div>
</div>

</div>

<!-- TAB IN B·∫¢NG GI√Å -->
<div id="printApp" class="hidden card p-4">

<h2 class="font-bold brand-text mb-3">In b·∫£ng gi√° qu·∫ßy</h2>

<div class="flex flex-wrap gap-2 mb-2">
<button onclick="startPrintScan()" class="brand-bg text-white px-3 py-2 rounded">üì∑ Qu√©t barcode</button>
<button onclick="exportText()" class="bg-slate-700 text-white px-3 py-2 rounded">‚¨á Xu·∫•t TXT</button>
<button onclick="clearPrintHistory()" class="bg-red-600 text-white px-3 py-2 rounded">üóë X√≥a</button>
</div>

<div id="printReader" class="hidden mb-2"></div>

<div class="chat-box" id="printHistory"></div>

</div>

<script>
/* MENU */
function toggleMenu(){
 sidebar.classList.toggle("active");
 overlay.classList.toggle("active");
}
function showMain(){
 mainApp.classList.remove("hidden");
 printApp.classList.add("hidden");
 toggleMenu();
}
function showPrint(){
 mainApp.classList.add("hidden");
 printApp.classList.remove("hidden");
 toggleMenu();
}

/* HSD */
const historyKey="coop_hsd_history";
let html5Qr=null;

function startScan(){
 const reader=document.getElementById("reader");
 reader.classList.remove("hidden");
 if(!html5Qr) html5Qr=new Html5Qrcode("reader");
 html5Qr.start({facingMode:"environment"},{fps:10,qrbox:250},code=>{
  barcode.value=code;
  html5Qr.stop();
  reader.classList.add("hidden");
 });
}

function calculate(){
 const nsx=new Date(nsx.value);
 const hsd=new Date(hsd.value);
 if(!nsx.value||!hsd.value||hsd<=nsx){alert("D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá");return;}

 const total=(hsd-nsx)/86400000;
 const date30=new Date(nsx.getTime()+total*0.7*86400000);
 const date20=new Date(nsx.getTime()+total*0.8*86400000);
 const today=new Date();

 let warn30="",warn20="",b30="",b20="",f30="B√¨nh th∆∞·ªùng",f20="B√¨nh th∆∞·ªùng";

 if(today>=date30){warn30="‚ö† Gi·∫£i t·ªìn";b30="blink30";f30="Gi·∫£i t·ªìn";}
 if(today>=date20){warn20="‚ö† R√∫t h√†ng";b20="blink20";f20="R√∫t h√†ng";}

 result.innerHTML=`
<div class="border p-3 mb-3 ${b30}">
<b>M·ªêC 30%</b><br>${date30.toLocaleDateString("vi-VN")}
<div>${warn30||"<span class='text-green-700'>Trong ng∆∞·ª°ng an to√†n</span>"}</div>
</div>

<div class="border p-3 ${b20}">
<b>M·ªêC 20%</b><br>${date20.toLocaleDateString("vi-VN")}
<div>${warn20||"<span class='text-green-700'>Trong ng∆∞·ª°ng an to√†n</span>"}</div>
</div>`;

 saveHistory(f30,f20);
}

function saveHistory(f30,f20){
 let h=JSON.parse(localStorage.getItem(historyKey)||"[]");
 h.unshift({
  Barcode:barcode.value,
  NSX:nsx.value,
  HSD:hsd.value,
  "C·∫£nh b√°o 30%":f30,
  "C·∫£nh b√°o 20%":f20,
  "Th·ªùi gian":new Date().toLocaleString("vi-VN")
 });
 localStorage.setItem(historyKey,JSON.stringify(h));
 renderHistory();
}

function renderHistory(){
 const h=JSON.parse(localStorage.getItem(historyKey)||"[]");
 history.innerHTML=h.map(x=>`<div>${x.Barcode} | 30%:${x["C·∫£nh b√°o 30%"]} | 20%:${x["C·∫£nh b√°o 20%"]}</div>`).join("");
 statistic.innerHTML=`üì¶ ${h.length} b·∫£n ghi`;
}
function clearHistory(){localStorage.removeItem(historyKey);renderHistory();}
function exportExcel(){
 const h=JSON.parse(localStorage.getItem(historyKey)||"[]");
 if(!h.length)return alert("Kh√¥ng c√≥ d·ªØ li·ªáu");
 const ws=XLSX.utils.json_to_sheet(h);
 const wb=XLSX.utils.book_new();
 XLSX.utils.book_append_sheet(wb,ws,"HSD");
 XLSX.writeFile(wb,"saigoncoop_hsd.xlsx");
}
function resetForm(){barcode.value="";nsx.value="";hsd.value="";result.innerHTML="";}
renderHistory();

/* IN B·∫¢NG GI√Å */
const printKey="coop_print_history";
let printQr=null;

function startPrintScan(){
 printReader.classList.remove("hidden");
 if(!printQr) printQr=new Html5Qrcode("printReader");
 printQr.start({facingMode:"environment"},{fps:10,qrbox:250},code=>{
   addOrIncreaseBarcode(code);
   printQr.stop();
   printReader.classList.add("hidden");
 });
}

function addOrIncreaseBarcode(code){
 let data=JSON.parse(localStorage.getItem(printKey)||"{}");
 data[code]=(data[code]||0)+1;
 localStorage.setItem(printKey,JSON.stringify(data));
 renderPrintHistory();
}

function renderPrintHistory(){
 const data=JSON.parse(localStorage.getItem(printKey)||"{}");
 printHistory.innerHTML=Object.entries(data)
 .map(([bc,qty])=>`<div class="chat-item">${bc},${qty};</div>`).join("");
}

function exportText(){
 const data=JSON.parse(localStorage.getItem(printKey)||"{}");
 if(!Object.keys(data).length){alert("Kh√¥ng c√≥ d·ªØ li·ªáu");return;}
 const content=Object.entries(data).map(([bc,qty])=>`${bc},${qty};`).join("\n");
 const blob=new Blob([content],{type:"text/plain"});
 const a=document.createElement("a");
 a.href=URL.createObjectURL(blob);
 a.download="barcode_print.txt";
 a.click();
}

function clearPrintHistory(){
 localStorage.removeItem(printKey);
 renderPrintHistory();
}
renderPrintHistory();
</script>

</body>
</html>
