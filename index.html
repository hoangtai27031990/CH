<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HỆ THỐNG QUẢN LÝ HSD – Saigon Co.op</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<style>
body{background:#f3f4f6}
.card{background:#fff;border-radius:14px;box-shadow:0 4px 16px rgba(0,0,0,.08)}
.brand-bg{background:#c40018}
.brand-text{color:#c40018}

/* ===== CẢNH BÁO ===== */
.blink30{animation:blink30 .6s linear infinite;border:2px solid #fb923c}
@keyframes blink30{0%{background:#fff3e0}50%{background:#ff9800;box-shadow:0 0 20px rgba(251,146,60,1)}100%{background:#fff3e0}}

.blink20{animation:blink20 .6s linear infinite;border:2px solid #ef4444}
@keyframes blink20{0%{background:#fff1f2}50%{background:#fecaca;box-shadow:0 0 20px rgba(239,68,68,1)}100%{background:#fff1f2}}

/* ===== SIDEBAR ===== */
#sidebar{position:fixed;top:0;left:0;width:260px;height:100%;background:#fff;box-shadow:4px 0 16px rgba(0,0,0,.15);transform:translateX(-100%);transition:.3s;z-index:1000}
#sidebar.active{transform:translateX(0)}
#overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;z-index:900}
#overlay.active{display:block}

/* ===== SCAN VIEW ===== */
.scan-box{position:relative}
.scan-line{
 position:absolute;
 top:50%;
 left:5%;
 width:90%;
 height:2px;
 background:red;
 animation:scanMove 1.2s linear infinite;
}
@keyframes scanMove{
 0%{top:30%}
 50%{top:55%}
 100%{top:80%}
}

.chat-box{height:420px;overflow:auto;background:#fafafa;border:1px solid #e5e7eb;border-radius:10px;padding:10px}
.chat-item{background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:6px 10px;margin-bottom:6px;font-family:monospace}

.filter-btn{padding:6px 12px;border-radius:6px;border:1px solid #ddd;background:#f5f5f5;cursor:pointer;font-size:13px}
.filter-btn.active{background:#2563eb;color:white;border-color:#2563eb}

/* ===== POPUP ===== */
#alertPopup{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:2000}
.popup-30{border:3px solid #fb923c}
.popup-20{border:3px solid #ef4444}
</style>
</head>

<body class="max-w-xl mx-auto p-3">

<!-- POPUP -->
<div id="alertPopup" class="hidden items-center justify-center">
  <div id="popupBox">
    <div id="popupTitle" class="font-bold text-lg mb-2"></div>
    <div id="popupMsg" class="mb-4"></div>
    <button onclick="closePopup()" class="brand-bg text-white px-4 py-2 rounded">Đã hiểu</button>
  </div>
</div>

<!-- HEADER -->
<div class="flex justify-between items-center mb-4 p-3 rounded-lg brand-bg text-white">
  <div class="font-bold">HỆ THỐNG QUẢN LÝ HSD</div>
</div>

<div class="card p-4 space-y-3">

<label class="font-semibold">Barcode sản phẩm</label>
<div class="flex gap-2">
<input id="barcode" class="border p-2 rounded w-full">
<button onclick="startScan()" class="brand-bg text-white px-3 rounded">Quét</button>
</div>

<div id="reader" class="hidden scan-box mt-2">
  <div class="scan-line"></div>
</div>

<label class="font-semibold">Ngày sản xuất (NSX)</label>
<input type="date" id="nsx" class="border p-2 rounded w-full">

<label class="font-semibold">Hạn sử dụng (HSD)</label>
<input type="date" id="hsd" class="border p-2 rounded w-full">

<div class="grid grid-cols-2 gap-2 pt-2">
<button onclick="calculate()" class="brand-bg text-white py-2 rounded">TÍNH KẾT QUẢ</button>
<button onclick="resetForm()" class="bg-gray-500 text-white py-2 rounded">TÍNH LẠI</button>
</div>

<div id="result"></div>
</div>

<script>
let qr;

/* ===== CONFIG QUÉT BARCODE – TỐI ƯU MOBILE YẾU ===== */
const scanConfig={
 fps:10,
 qrbox:{width:260,height:120},
 aspectRatio:1.777,
 disableFlip:true,
 experimentalFeatures:{
  useBarCodeDetectorIfSupported:true
 }
};

function startScan(){
 const r=document.getElementById("reader");
 r.classList.remove("hidden");

 if(!qr) qr=new Html5Qrcode("reader");

 qr.start(
  { facingMode:{ ideal:"environment" } },
  scanConfig,
  code=>{
    barcode.value=code;
    stopScan();
  }
 ).catch(()=>{
  // fallback thiết bị yếu
  qr.start({facingMode:"environment"},scanConfig,code=>{
    barcode.value=code;
    stopScan();
  });
 });
}

function stopScan(){
 qr.stop().then(()=>{
  qr.clear();
  document.getElementById("reader").classList.add("hidden");
 });
}

/* ===== PHẦN LOGIC TÍNH TOÁN GIỮ NGUYÊN ===== */
function calculate(){
 const nsxVal=nsx.value, hsdVal=hsd.value;
 if(!nsxVal||!hsdVal){alert("Nhập đủ NSX & HSD");return}
 const nsxD=new Date(nsxVal), hsdD=new Date(hsdVal);
 if(hsdD<=nsxD){alert("HSD phải lớn hơn NSX");return}

 const total=(hsdD-nsxD)/86400000;
 const d30=new Date(nsxD.getTime()+total*0.7*86400000);
 const d20=new Date(nsxD.getTime()+total*0.8*86400000);
 const today=new Date();

 result.innerHTML=`
 <div class="border p-3 ${today>=d30?'blink30':''}">
  <b>MỐC 30%</b>: ${d30.toLocaleDateString('vi-VN')}
 </div>
 <div class="border p-3 ${today>=d20?'blink20':''}">
  <b>MỐC 20%</b>: ${d20.toLocaleDateString('vi-VN')}
 </div>
 `;
}

function resetForm(){
 barcode.value="";nsx.value="";hsd.value="";result.innerHTML="";
}

function closePopup(){
 alertPopup.classList.add("hidden");
 alertPopup.classList.remove("flex");
}
</script>

</body>
</html>
