<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HỆ THỐNG QUẢN LÝ HSD – Saigon Co.op</title>

<script src="https://cdn.tailwindcss.com"></script>

<!-- QUAGGA2 – BARCODE 1D -->
<script src="https://unpkg.com/@ericblade/quagga2/dist/quagga.min.js"></script>

<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<style>
body{background:#f3f4f6}
.card{background:#fff;border-radius:14px;box-shadow:0 4px 16px rgba(0,0,0,.08)}
.brand-bg{background:#c40018}
.brand-text{color:#c40018}

.blink30{animation:blink30 .6s linear infinite;border:2px solid #fb923c}
@keyframes blink30{0%{background:#fff3e0}50%{background:#ff9800;box-shadow:0 0 20px rgba(251,146,60,1)}100%{background:#fff3e0}}

.blink20{animation:blink20 .6s linear infinite;border:2px solid #ef4444}
@keyframes blink20{0%{background:#fff1f2}50%{background:#fecaca;box-shadow:0 0 20px rgba(239,68,68,1)}100%{background:#fff1f2}}

#reader,#printReader{
  width:100%;
  height:220px;
  background:#000;
  border-radius:10px;
  overflow:hidden
}
</style>
</head>

<body class="max-w-xl mx-auto p-3">

<!-- ================= UI GIỮ NGUYÊN 100% ================= -->

<div class="flex justify-between items-center mb-4 p-3 rounded-lg brand-bg text-white">
  <div class="flex items-center gap-2">
    <img src="logo.png" class="h-8 bg-white rounded p-1">
    <div>
      <div class="font-bold text-lg">HỆ THỐNG QUẢN LÝ HSD</div>
      <div class="text-sm opacity-90">Saigon Co.op</div>
    </div>
  </div>
</div>

<div class="card p-4 space-y-3">

<label class="font-semibold">Barcode sản phẩm</label>
<div class="flex gap-2">
<input id="barcode" class="border p-2 rounded w-full">
<button onclick="startScan()" class="brand-bg text-white px-3 rounded">Quét</button>
</div>

<div id="reader" class="hidden mt-2"></div>

<label class="font-semibold">Ngày sản xuất (NSX)</label>
<input type="date" id="nsx" class="border p-2 rounded w-full">

<label class="font-semibold">Hạn sử dụng (HSD)</label>
<input type="date" id="hsd" class="border p-2 rounded w-full">

<div class="grid grid-cols-2 gap-2 pt-2">
<button onclick="calculate()" class="brand-bg text-white py-2 rounded font-semibold">TÍNH KẾT QUẢ</button>
<button onclick="resetForm()" class="bg-gray-500 text-white py-2 rounded font-semibold">TÍNH LẠI</button>
</div>

<div id="result" class="pt-2"></div>
</div>

<!-- ================= LOGIC NGHIỆP VỤ GIỮ NGUYÊN ================= -->

<script>
/* ===== BARCODE ENGINE (QUAGGA2) ===== */

let scanning=false;
let lastCode="",lastTime=0;

function accept(code){
 const now=Date.now();
 if(code===lastCode && now-lastTime<1500) return false;
 lastCode=code;lastTime=now;return true;
}

function quaggaCfg(target){
 return{
  inputStream:{
   type:"LiveStream",
   target,
   constraints:{facingMode:"environment",width:{ideal:640},height:{ideal:480}}
  },
  frequency:6,
  locator:{patchSize:"medium",halfSample:true},
  decoder:{readers:["ean_reader","ean_8_reader","code_128_reader","upc_reader"]},
  locate:true
 };
}

function startScan(){
 if(scanning) return;
 scanning=true;
 reader.classList.remove("hidden");

 Quagga.init(quaggaCfg(reader),err=>{
  if(err){alert("Không mở được camera");scanning=false;return;}
  Quagga.start();
 });

 Quagga.onDetected(d=>{
  const code=d.codeResult.code;
  if(!accept(code)) return;
  barcode.value=code;
  Quagga.stop();Quagga.offDetected();
  reader.classList.add("hidden");
  scanning=false;
 });
}

/* ===== NGHIỆP VỤ TÍNH HSD (GIỮ NGUYÊN) ===== */

function calculate(){
 const nsxVal=nsx.value,hsdVal=hsd.value;
 if(!nsxVal||!hsdVal){alert("Nhập đủ NSX & HSD");return}
 const nsxD=new Date(nsxVal),hsdD=new Date(hsdVal);
 if(hsdD<=nsxD){alert("HSD phải lớn hơn NSX");return}

 const total=(hsdD-nsxD)/86400000;
 const d30=new Date(nsxD.getTime()+total*0.7*86400000);
 const d20=new Date(nsxD.getTime()+total*0.8*86400000);
 const today=new Date();

 let b30="",b20="";
 if(today>=d30)b30="blink30";
 if(today>=d20)b20="blink20";

 result.innerHTML=`
 <div class="border p-3 mb-2 ${b30}"><b>MỐC 30%</b> ${d30.toLocaleDateString("vi-VN")}</div>
 <div class="border p-3 ${b20}"><b>MỐC 20%</b> ${d20.toLocaleDateString("vi-VN")}</div>`;
}

function resetForm(){
 barcode.value="";nsx.value="";hsd.value="";result.innerHTML="";
}
</script>

</body>
</html>
