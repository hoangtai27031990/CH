<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HỆ THỐNG QUẢN LÝ HSD – Saigon Co.op</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/@ericblade/quagga2/dist/quagga.min.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<style>
body{background:#f3f4f6}
.card{background:#fff;border-radius:14px;box-shadow:0 4px 16px rgba(0,0,0,.08)}
.brand-bg{background:#c40018}
.brand-text{color:#c40018}

.blink30{animation:blink30 .6s linear infinite;border:2px solid #fb923c}
@keyframes blink30{0%{background:#fff3e0}50%{background:#ff9800;box-shadow:0 0 20px rgba(251,146,60,1)}100%{background:#fff3e0}}

.blink20{animation:blink20 .6s linear infinite;border:2px solid #ef4444}
@keyframes blink20{0%{background:#fff1f2}50%{background:#fecaca;box-shadow:0 0 20px rgba(239,68,68,1)}100%{background:#fff1f2}}

#sidebar{position:fixed;top:0;left:0;width:260px;height:100%;background:#fff;box-shadow:4px 0 16px rgba(0,0,0,.15);transform:translateX(-100%);transition:.3s;z-index:1000}
#sidebar.active{transform:translateX(0)}
#overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;z-index:900}
#overlay.active{display:block}
</style>
</head>

<body class="max-w-xl mx-auto p-3">

<!-- ===== UI & NGHIỆP VỤ GIỮ NGUYÊN 100% ===== -->
<div class="flex justify-between items-center mb-4 p-3 rounded-lg brand-bg text-white">
  <div class="flex items-center gap-2">
    <div class="font-bold text-lg">HỆ THỐNG QUẢN LÝ HSD</div>
    <div class="text-sm opacity-90">Saigon Co.op</div>
  </div>
  <button onclick="toggleMenu()" class="text-2xl">☰</button>
</div>

<div class="card p-4 space-y-3">
<label class="font-semibold">Barcode sản phẩm</label>
<div class="flex gap-2">
<input id="barcode" class="border p-2 rounded w-full">
<button onclick="startScan()" class="brand-bg text-white px-3 rounded">Quét</button>
</div>
<div id="reader" class="hidden mt-2"></div>
</div>

<script>
/* ==========================
   QUAGGA2 – FINAL ENGINE
   Không đổi UI – Không reload Safari
   ========================== */
let quaggaRunning=false;
let activeTarget=null;
let overlayBox=null;
let lastCode="";
let lastTime=0;

function addScanOverlay(target){
  overlayBox=document.createElement('div');
  overlayBox.style.position='absolute';
  overlayBox.style.inset='0';
  overlayBox.style.display='flex';
  overlayBox.style.alignItems='center';
  overlayBox.style.justifyContent='center';
  overlayBox.style.pointerEvents='none';

  const frame=document.createElement('div');
  frame.style.width='80%';
  frame.style.height='90px';
  frame.style.border='3px solid #c40018';
  frame.style.borderRadius='8px';

  overlayBox.appendChild(frame);
  target.style.position='relative';
  target.appendChild(overlayBox);
}

function cleanupQuagga(){
  try{Quagga.offDetected();}catch(e){}
  try{Quagga.stop();}catch(e){}
  if(overlayBox){overlayBox.remove();overlayBox=null}
  if(activeTarget){activeTarget.classList.add('hidden');activeTarget.innerHTML=''}
  quaggaRunning=false;
  activeTarget=null;
}

function startQuagga(targetId,onResult){
  if(quaggaRunning) return;
  quaggaRunning=true;

  const target=document.getElementById(targetId);
  activeTarget=target;
  target.classList.remove('hidden');
  target.innerHTML='';
  addScanOverlay(target);

  Quagga.init({
    inputStream:{
      type:'LiveStream',
      target:target,
      constraints:{facingMode:'environment',width:{ideal:640},height:{ideal:480}},
      area:{top:'40%',right:'10%',left:'10%',bottom:'40%'}
    },
    locator:{patchSize:'medium',halfSample:true},
    numOfWorkers:1,
    frequency:6,
    decoder:{readers:['ean_reader','ean_8_reader','upc_reader','code_128_reader']},
    locate:true
  },err=>{
    if(err){cleanupQuagga();return;}
    Quagga.start();
  });

  Quagga.onDetected(res=>{
    if(!res||!res.codeResult) return;
    const code=res.codeResult.code;
    const now=Date.now();
    if(code===lastCode && now-lastTime<1500) return;
    lastCode=code; lastTime=now;
    cleanupQuagga();
    onResult(code);
  });
}

/* ===== Override đúng yêu cầu ===== */
function startScan(){
  startQuagga('reader',code=>{barcode.value=code});
}

function toggleMenu(){}
</script>
</body>
</html>
