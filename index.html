
import React, { useState, useEffect, useCallback } from 'react';
import { HSDRecord, FilterType, PrintItem } from './types';
import Scanner from './components/Scanner';

// External declaration for libraries loaded in index.html
declare const XLSX: any;

const App: React.FC = () => {
  const [activeTab, setActiveTab] = useState<'main' | 'print'>('main');
  const [sidebarOpen, setSidebarOpen] = useState(false);
  const [showScanner, setShowScanner] = useState(false);
  const [scannerTarget, setScannerTarget] = useState<'main' | 'print'>('main');

  // Main Form State
  const [barcode, setBarcode] = useState('');
  const [nsx, setNsx] = useState('');
  const [hsd, setHsd] = useState('');
  const [result, setResult] = useState<{ b30: string; b20: string; date30: string; date20: string; warn30: string; warn20: string } | null>(null);
  const [history, setHistory] = useState<HSDRecord[]>([]);
  const [filter, setFilter] = useState<FilterType>('all');

  // Print State
  const [printHistory, setPrintHistory] = useState<Record<string, number>>({});

  // Popup State
  const [popup, setPopup] = useState<{ type: string; title: string; msg: string } | null>(null);

  useEffect(() => {
    const savedHistory = localStorage.getItem('coop_hsd_history');
    if (savedHistory) setHistory(JSON.parse(savedHistory));

    const savedPrint = localStorage.getItem('coop_print_history');
    if (savedPrint) setPrintHistory(JSON.parse(savedPrint));
  }, []);

  const toggleSidebar = () => setSidebarOpen(!sidebarOpen);

  const handleScan = (code: string) => {
    if (scannerTarget === 'main') {
      setBarcode(code);
    } else {
      const newPrint = { ...printHistory };
      newPrint[code] = (newPrint[code] || 0) + 1;
      setPrintHistory(newPrint);
      localStorage.setItem('coop_print_history', JSON.stringify(newPrint));
    }
    setShowScanner(false);
  };

  const calculateHSD = () => {
    if (!nsx || !hsd) {
      alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß NSX & HSD");
      return;
    }
    const nsxD = new Date(nsx);
    const hsdD = new Date(hsd);
    if (hsdD <= nsxD) {
      alert("HSD ph·∫£i l·ªõn h∆°n NSX");
      return;
    }

    const totalDays = (hsdD.getTime() - nsxD.getTime()) / 86400000;
    const date30 = new Date(nsxD.getTime() + totalDays * 0.7 * 86400000);
    const date20 = new Date(nsxD.getTime() + totalDays * 0.8 * 86400000);
    const today = new Date();

    let warn30 = "", warn20 = "", b30 = "", b20 = "", f30 = "B√¨nh th∆∞·ªùng", f20 = "B√¨nh th∆∞·ªùng";

    if (today >= date30) {
      warn30 = "‚ö†Ô∏è B√°o c√°o Qu·∫£n l√Ω gi·∫£i t·ªìn";
      b30 = "blink30";
      f30 = "Gi·∫£i t·ªìn";
    }
    if (today >= date20) {
      warn20 = "‚ö†Ô∏è R√∫t h√†ng kh·ªèi qu·∫ßy";
      b20 = "blink20";
      f20 = "R√∫t h√†ng";
    }

    setResult({
      b30, b20,
      date30: date30.toLocaleDateString("vi-VN"),
      date20: date20.toLocaleDateString("vi-VN"),
      warn30, warn20
    });

    const newRecord: HSDRecord = {
      Barcode: barcode || "N/A",
      NSX: nsx,
      HSD: hsd,
      "C·∫£nh b√°o 30%": f30,
      "C·∫£nh b√°o 20%": f20,
      "Th·ªùi gian": new Date().toLocaleString("vi-VN")
    };

    const newHistory = [newRecord, ...history];
    setHistory(newHistory);
    localStorage.setItem('coop_hsd_history', JSON.stringify(newHistory));

    if (today >= date20) {
      showPopupAlert("20", "C·∫¢NH B√ÅO M·ªêC 20%", "R√∫t h√†ng kh·ªèi qu·∫ßy ngay.");
    } else if (today >= date30) {
      showPopupAlert("30", "C·∫¢NH B√ÅO M·ªêC 30%", "B√°o c√°o qu·∫£n l√Ω ƒë·ªÉ th·ª±c hi·ªán gi·∫£i t·ªìn.");
    }
  };

  const showPopupAlert = (type: string, title: string, msg: string) => {
    setPopup({ type, title, msg });
  };

  const exportExcel = () => {
    if (history.length === 0) {
      alert("Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t");
      return;
    }
    const ws = XLSX.utils.json_to_sheet(history);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "HSD");
    XLSX.writeFile(wb, "saigoncoop_hsd.xlsx");
    
    setHistory([]);
    localStorage.removeItem('coop_hsd_history');
    showPopupAlert("export", "‚úÖ XU·∫§T FILE TH√ÄNH C√îNG", "D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c t·∫£i v·ªÅ v√† h·ªá th·ªëng ƒë√£ s·∫µn s√†ng.");
    setTimeout(() => setPopup(null), 2500);
  };

  const clearHistory = () => {
    if (window.confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a to√†n b·ªô l·ªãch s·ª≠?")) {
      setHistory([]);
      localStorage.removeItem('coop_hsd_history');
    }
  };

  const resetForm = () => {
    setBarcode('');
    setNsx('');
    setHsd('');
    setResult(null);
  };

  const filteredHistory = history.filter(item => {
    if (filter === '30') return item["C·∫£nh b√°o 30%"] === 'Gi·∫£i t·ªìn';
    if (filter === '20') return item["C·∫£nh b√°o 20%"] === 'R√∫t h√†ng';
    return true;
  });

  const exportPrintText = () => {
    const keys = Object.keys(printHistory);
    if (keys.length === 0) {
      alert("Kh√¥ng c√≥ d·ªØ li·ªáu");
      return;
    }
    const txt = keys.map(k => `${k},${printHistory[k]}`).join("\n");
    const blob = new Blob([txt], { type: "text/plain;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "barcode_print.txt";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    setPrintHistory({});
    localStorage.removeItem('coop_print_history');
    showPopupAlert("export", "‚úÖ XU·∫§T FILE TH√ÄNH C√îNG", "D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c t·∫£i v·ªÅ.");
    setTimeout(() => setPopup(null), 2500);
  };

  return (
    <div className="max-w-xl mx-auto min-h-screen pb-10">
      {/* Sidebar Overlay */}
      {sidebarOpen && (
        <div 
          className="fixed inset-0 bg-black bg-opacity-50 z-40 transition-opacity"
          onClick={toggleSidebar}
        />
      )}

      {/* Sidebar Content */}
      <div className={`fixed top-0 left-0 w-64 h-full bg-white z-50 transform transition-transform duration-300 ease-in-out ${sidebarOpen ? 'translate-x-0' : '-translate-x-full'} shadow-2xl`}>
        <div className="p-6 border-b text-center bg-gray-50">
          <div className="w-16 h-16 bg-red-600 rounded-full mx-auto mb-3 flex items-center justify-center text-white font-bold text-2xl">COOP</div>
          <div className="font-bold text-red-700 text-lg uppercase tracking-wider">Saigon Co.op</div>
        </div>
        <div className="p-4 space-y-3">
          <button 
            onClick={() => { setActiveTab('main'); setSidebarOpen(false); }}
            className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl font-medium transition-colors ${activeTab === 'main' ? 'bg-red-50 text-red-600' : 'hover:bg-gray-100'}`}
          >
            <span className="text-xl">üì¶</span> Qu·∫£n l√Ω HSD
          </button>
          <button 
            onClick={() => { setActiveTab('print'); setSidebarOpen(false); }}
            className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl font-medium transition-colors ${activeTab === 'print' ? 'bg-red-50 text-red-600' : 'hover:bg-gray-100'}`}
          >
            <span className="text-xl">üñ®Ô∏è</span> In b·∫£ng gi√° qu·∫ßy
          </button>
        </div>
        <div className="absolute bottom-6 left-0 w-full px-6">
          <p className="text-xs text-center text-gray-400 font-mono">Ver 2.5 - Optimized Scan</p>
        </div>
      </div>

      {/* Header */}
      <div className="bg-red-600 text-white p-4 shadow-lg flex justify-between items-center sticky top-0 z-30">
        <div className="flex items-center gap-3">
           <div className="w-10 h-10 bg-white rounded-lg flex items-center justify-center font-bold text-red-600 text-sm">COOP</div>
           <div>
             <h1 className="font-bold text-base leading-tight">H·ªÜ TH·ªêNG QU·∫¢N L√ù HSD</h1>
             <p className="text-xs opacity-80 uppercase">Si√™u th·ªã Saigon Co.op</p>
           </div>
        </div>
        <button onClick={toggleSidebar} className="p-2 hover:bg-red-700 rounded-full transition-colors">
          <svg className="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 6h16M4 12h16m-7 6h7" /></svg>
        </button>
      </div>

      {/* Main Content Area */}
      <div className="p-4 space-y-4">
        {activeTab === 'main' ? (
          <div className="animate-in fade-in slide-in-from-bottom-4 duration-500">
            {/* Form Card */}
            <div className="bg-white rounded-2xl shadow-md p-5 space-y-4 border border-gray-100">
              <div className="space-y-2">
                <label className="text-sm font-bold text-gray-700 flex justify-between items-center">
                  M√É V·∫†CH S·∫¢N PH·∫®M
                  <span className="text-[10px] text-gray-400 font-normal">S·ª≠ d·ª•ng EAN-13, EAN-8...</span>
                </label>
                <div className="flex gap-2">
                  <input 
                    value={barcode} 
                    onChange={e => setBarcode(e.target.value)}
                    placeholder="Nh·∫≠p m√£ v·∫°ch ho·∫∑c qu√©t"
                    className="flex-1 border-2 border-gray-100 rounded-xl px-4 py-3 focus:border-red-400 outline-none transition-colors"
                  />
                  <button 
                    onClick={() => { setScannerTarget('main'); setShowScanner(true); }}
                    className="bg-red-600 text-white px-5 rounded-xl flex items-center justify-center hover:bg-red-700 active:scale-95 transition-all shadow-md"
                  >
                    <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                  </button>
                </div>
              </div>

              <div className="grid grid-cols-2 gap-4">
                <div className="space-y-1">
                  <label className="text-sm font-bold text-gray-700 uppercase">Ng√†y SX</label>
                  <input 
                    type="date" 
                    value={nsx} 
                    onChange={e => setNsx(e.target.value)}
                    className="w-full border-2 border-gray-100 rounded-xl px-3 py-3 focus:border-red-400 outline-none"
                  />
                </div>
                <div className="space-y-1">
                  <label className="text-sm font-bold text-gray-700 uppercase">H·∫°n SD</label>
                  <input 
                    type="date" 
                    value={hsd} 
                    onChange={e => setHsd(e.target.value)}
                    className="w-full border-2 border-gray-100 rounded-xl px-3 py-3 focus:border-red-400 outline-none"
                  />
                </div>
              </div>

              <div className="grid grid-cols-2 gap-3 pt-2">
                <button 
                  onClick={calculateHSD}
                  className="bg-red-600 text-white py-4 rounded-xl font-bold uppercase tracking-widest shadow-lg hover:bg-red-700 active:scale-95 transition-all"
                >
                  T√çNH K·∫æT QU·∫¢
                </button>
                <button 
                  onClick={resetForm}
                  className="bg-gray-400 text-white py-4 rounded-xl font-bold uppercase tracking-widest hover:bg-gray-500 transition-all"
                >
                  L√ÄM M·ªöI
                </button>
              </div>

              {result && (
                <div className="pt-4 space-y-3">
                   <div className={`p-4 rounded-2xl border-2 flex justify-between items-center ${result.b30 || 'bg-green-50 border-green-200'}`}>
                      <div>
                        <p className="text-xs font-bold text-gray-500 uppercase">M·ªëc gi·∫£i t·ªìn (30%)</p>
                        <p className="text-xl font-mono font-bold">{result.date30}</p>
                      </div>
                      <div className="text-right">
                        {result.warn30 ? <span className="text-red-600 font-bold text-sm animate-pulse">{result.warn30}</span> : <span className="text-green-600 font-bold text-sm">‚úÖ An to√†n</span>}
                      </div>
                   </div>
                   <div className={`p-4 rounded-2xl border-2 flex justify-between items-center ${result.b20 || 'bg-green-50 border-green-200'}`}>
                      <div>
                        <p className="text-xs font-bold text-gray-500 uppercase">M·ªëc r√∫t h√†ng (20%)</p>
                        <p className="text-xl font-mono font-bold">{result.date20}</p>
                      </div>
                      <div className="text-right">
                        {result.warn20 ? <span className="text-red-600 font-bold text-sm animate-pulse">{result.warn20}</span> : <span className="text-green-600 font-bold text-sm">‚úÖ An to√†n</span>}
                      </div>
                   </div>
                </div>
              )}

              <div className="grid grid-cols-2 gap-3 pt-4 border-t border-gray-100">
                <button 
                  onClick={exportExcel}
                  className="flex items-center justify-center gap-2 bg-slate-700 text-white py-3 rounded-xl text-sm font-semibold hover:bg-slate-800 transition-all"
                >
                  üì• XU·∫§T EXCEL
                </button>
                <button 
                  onClick={clearHistory}
                  className="flex items-center justify-center gap-2 bg-red-100 text-red-600 py-3 rounded-xl text-sm font-semibold hover:bg-red-200 transition-all"
                >
                  üóëÔ∏è X√ìA L·ªäCH S·ª¨
                </button>
              </div>
            </div>

            {/* History Section */}
            <div className="bg-white rounded-2xl shadow-md p-5 border border-gray-100">
              <div className="flex justify-between items-center mb-4">
                <h2 className="font-bold text-red-700 uppercase tracking-wide">L·ªãch s·ª≠ t√≠nh to√°n</h2>
                <span className="bg-red-50 text-red-600 text-[10px] font-bold px-2 py-1 rounded-full">T·ªïng: {filteredHistory.length}</span>
              </div>

              <div className="flex gap-2 mb-4 overflow-x-auto pb-2">
                <button 
                  onClick={() => setFilter('all')}
                  className={`px-4 py-2 rounded-lg text-xs font-bold whitespace-nowrap transition-all ${filter === 'all' ? 'bg-red-600 text-white shadow-md' : 'bg-gray-100 text-gray-500 hover:bg-gray-200'}`}
                >
                  T·∫§T C·∫¢
                </button>
                <button 
                  onClick={() => setFilter('30')}
                  className={`px-4 py-2 rounded-lg text-xs font-bold whitespace-nowrap transition-all ${filter === '30' ? 'bg-orange-500 text-white shadow-md' : 'bg-gray-100 text-gray-500 hover:bg-gray-200'}`}
                >
                  GI·∫¢I T·ªíN (30%)
                </button>
                <button 
                  onClick={() => setFilter('20')}
                  className={`px-4 py-2 rounded-lg text-xs font-bold whitespace-nowrap transition-all ${filter === '20' ? 'bg-red-700 text-white shadow-md' : 'bg-gray-100 text-gray-500 hover:bg-gray-200'}`}
                >
                  R√öT H√ÄNG (20%)
                </button>
              </div>

              <div className="space-y-3 max-h-80 overflow-y-auto pr-1">
                {filteredHistory.length > 0 ? filteredHistory.map((item, idx) => (
                  <div key={idx} className="bg-gray-50 border border-gray-100 rounded-xl p-3 flex flex-col gap-1 shadow-sm">
                    <div className="flex justify-between items-start">
                      <span className="font-mono text-sm font-bold text-gray-700">{item.Barcode}</span>
                      <span className="text-[10px] text-gray-400">{item["Th·ªùi gian"]}</span>
                    </div>
                    <div className="flex gap-4 mt-1">
                      <div className="flex-1">
                        <p className="text-[9px] uppercase font-bold text-gray-400">Tr·∫°ng th√°i 30%</p>
                        <p className={`text-xs font-bold ${item["C·∫£nh b√°o 30%"] === 'Gi·∫£i t·ªìn' ? 'text-orange-600' : 'text-green-600'}`}>{item["C·∫£nh b√°o 30%"]}</p>
                      </div>
                      <div className="flex-1">
                        <p className="text-[9px] uppercase font-bold text-gray-400">Tr·∫°ng th√°i 20%</p>
                        <p className={`text-xs font-bold ${item["C·∫£nh b√°o 20%"] === 'R√∫t h√†ng' ? 'text-red-600' : 'text-green-600'}`}>{item["C·∫£nh b√°o 20%"]}</p>
                      </div>
                    </div>
                  </div>
                )) : (
                  <div className="text-center py-10">
                    <p className="text-gray-400 italic text-sm">Ch∆∞a c√≥ d·ªØ li·ªáu ph√π h·ª£p</p>
                  </div>
                )}
              </div>
            </div>
          </div>
        ) : (
          <div className="animate-in fade-in slide-in-from-bottom-4 duration-500 space-y-4">
            <div className="bg-white rounded-2xl shadow-md p-5 space-y-4 border border-gray-100">
               <h2 className="font-bold text-red-700 uppercase tracking-wide">In b·∫£ng gi√° qu·∫ßy</h2>
               <div className="grid grid-cols-2 gap-3">
                 <button 
                   onClick={() => { setScannerTarget('print'); setShowScanner(true); }}
                   className="flex items-center justify-center gap-2 bg-red-600 text-white py-4 rounded-xl font-bold shadow-lg active:scale-95 transition-all"
                 >
                   <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                   QU√âT M√É
                 </button>
                 <button 
                   onClick={exportPrintText}
                   className="flex items-center justify-center gap-2 bg-slate-700 text-white py-4 rounded-xl font-bold shadow-lg active:scale-95 transition-all"
                 >
                   üì• XU·∫§T TXT
                 </button>
               </div>
               <button 
                 onClick={() => { if(window.confirm("X√≥a danh s√°ch?")) { setPrintHistory({}); localStorage.removeItem('coop_print_history'); } }}
                 className="w-full bg-red-50 text-red-600 py-3 rounded-xl font-bold text-sm border border-red-100"
               >
                 üóëÔ∏è X√ìA DANH S√ÅCH HI·ªÜN T·∫†I
               </button>
            </div>

            <div className="bg-white rounded-2xl shadow-md p-5 border border-gray-100">
               <div className="flex justify-between items-center mb-3">
                 <h3 className="text-xs font-bold text-gray-500 uppercase">Danh s√°ch chu·∫©n b·ªã in</h3>
                 <span className="text-[10px] text-gray-400">ƒê√£ qu√©t: {Object.keys(printHistory).length} m√£</span>
               </div>
               <div className="bg-gray-50 border border-gray-200 rounded-xl p-3 min-h-[300px] max-h-[500px] overflow-y-auto">
                 {Object.keys(printHistory).length > 0 ? (
                   <div className="space-y-2 font-mono text-sm">
                     {Object.entries(printHistory).map(([code, qty], i) => (
                       <div key={i} className="flex justify-between items-center p-2 bg-white rounded-lg border border-gray-100">
                         <span className="font-bold">{code}</span>
                         <span className="bg-red-600 text-white px-3 py-1 rounded-full text-xs">{qty}</span>
                       </div>
                     ))}
                   </div>
                 ) : (
                   <div className="flex flex-col items-center justify-center py-20 text-gray-400">
                      <svg className="w-12 h-12 mb-2 opacity-20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg>
                      <p className="italic text-sm">Ch∆∞a c√≥ m√£ n√†o ƒë∆∞·ª£c qu√©t</p>
                   </div>
                 )}
               </div>
            </div>
          </div>
        )}
      </div>

      {/* Popups */}
      {popup && (
        <div className="fixed inset-0 bg-black bg-opacity-70 z-[100] flex items-center justify-center p-6 backdrop-blur-sm transition-opacity">
          <div className={`bg-white rounded-3xl p-8 max-w-sm w-full text-center shadow-2xl border-4 transform scale-110 duration-300 ${popup.type === '30' ? 'border-orange-500' : popup.type === '20' ? 'border-red-600' : 'border-green-500'}`}>
             <h3 className="text-xl font-black mb-3 uppercase tracking-tighter">{popup.title}</h3>
             <p className="text-gray-600 mb-8 font-medium leading-relaxed">{popup.msg}</p>
             <button 
               onClick={() => setPopup(null)}
               className="w-full bg-red-600 text-white py-4 rounded-2xl font-bold uppercase shadow-lg hover:bg-red-700 active:scale-95 transition-all"
             >
               ƒê√É HI·ªÇU
             </button>
          </div>
        </div>
      )}

      {/* Scanner Component */}
      {showScanner && (
        <Scanner 
          onScan={handleScan} 
          onClose={() => setShowScanner(false)} 
        />
      )}
    </div>
  );
};

export default App;
