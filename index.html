<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>H·ªÜ TH·ªêNG QU·∫¢N L√ù HSD ‚Äì Saigon Co.op</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<style>
body{background:#f3f4f6}
.card{background:#fff;border-radius:14px;box-shadow:0 4px 16px rgba(0,0,0,.08)}
.brand-bg{background:#c40018}
.brand-text{color:#c40018}

.blink30{animation:blink30 .6s linear infinite;border:2px solid #fb923c}
@keyframes blink30{0%{background:#fff3e0}50%{background:#ff9800;box-shadow:0 0 20px rgba(251,146,60,1)}100%{background:#fff3e0}}

.blink20{animation:blink20 .6s linear infinite;border:2px solid #ef4444}
@keyframes blink20{0%{background:#fff1f2}50%{background:#fecaca;box-shadow:0 0 20px rgba(239,68,68,1)}100%{background:#fff1f2}}

#sidebar{position:fixed;top:0;left:0;width:260px;height:100%;background:#fff;box-shadow:4px 0 16px rgba(0,0,0,.15);transform:translateX(-100%);transition:.3s;z-index:1000}
#sidebar.active{transform:translateX(0)}
#overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;z-index:900}
#overlay.active{display:block}

.filter-btn{padding:6px 12px;border-radius:6px;border:1px solid #ddd;background:#f5f5f5;cursor:pointer;font-size:13px}
.filter-btn.active{background:#2563eb;color:white;border-color:#2563eb}

/* CAMERA */
#reader,#printReader{
  position:relative;
  width:100%;
  height:260px;
  background:#000;
}
.scan-frame{
  position:absolute;
  inset:0;
  border:2px solid rgba(255,255,255,.3);
  z-index:10;
}
.scan-line{
  position:absolute;
  left:5%;
  width:90%;
  height:4px;
  background:red;
  box-shadow:0 0 12px red;
  animation:scanMove 1.2s linear infinite;
  z-index:20;
}
@keyframes scanMove{
  0%{top:30%}
  50%{top:50%}
  100%{top:70%}
}
</style>
</head>

<body class="max-w-xl mx-auto p-3">

<div class="flex justify-between items-center mb-4 p-3 rounded-lg brand-bg text-white">
  <div class="font-bold">H·ªÜ TH·ªêNG QU·∫¢N L√ù HSD</div>
</div>

<div class="card p-4 space-y-3">
<label class="font-semibold">Barcode s·∫£n ph·∫©m</label>
<div class="flex gap-2">
<input id="barcode" class="border p-2 rounded w-full">
<button onclick="startScan()" class="brand-bg text-white px-3 rounded">Qu√©t</button>
</div>

<div id="reader" class="hidden"></div>

<label class="font-semibold">Ng√†y s·∫£n xu·∫•t</label>
<input type="date" id="nsx" class="border p-2 rounded w-full">

<label class="font-semibold">H·∫°n s·ª≠ d·ª•ng</label>
<input type="date" id="hsd" class="border p-2 rounded w-full">

<button onclick="calculate()" class="brand-bg text-white py-2 rounded font-semibold w-full">T√çNH K·∫æT QU·∫¢</button>
<div id="result"></div>

<button onclick="exportExcel()" class="bg-slate-700 text-white py-2 rounded w-full">Xu·∫•t Excel</button>
</div>

<div class="card p-3 mt-4">
<h2 class="font-bold brand-text mb-2">In b·∫£ng gi√° qu·∫ßy</h2>
<button onclick="startPrintScan()" class="brand-bg text-white px-3 py-2 rounded mb-2">üì∑ Qu√©t barcode</button>
<div id="printReader" class="hidden"></div>
<div id="printHistory" class="text-sm mt-2"></div>
</div>

<script>
/* ===== KI·ªÇM TRA ANDROID ===== */
function isAndroid(){return /Android/i.test(navigator.userAgent);}

/* ===== BI·∫æN ===== */
let qr=null, qr2=null;
const historyKey="coop_hsd_history";
const printKey="coop_print_history";

/* ===== CONFIG QU√âT ===== */
const scanConfig={
  fps:8,
  disableFlip:true,
  qrbox:{width:280,height:100},
  experimentalFeatures:{useBarCodeDetectorIfSupported:true}
};

/* ===== QU√âT HSD ===== */
function startScan(){
  if(!isAndroid()){alert("Ch·ªâ h·ªó tr·ª£ Android");return;}
  const r=document.getElementById("reader");
  r.innerHTML='<div class="scan-frame"><div class="scan-line"></div></div>';
  r.classList.remove("hidden");

  if(!qr) qr=new Html5Qrcode("reader");
  qr.start({facingMode:"environment"},scanConfig,
    code=>{
      barcode.value=code;
      qr.stop().then(()=>{qr.clear();r.classList.add("hidden");});
    }
  );
}

/* ===== QU√âT IN B·∫¢NG GI√Å ===== */
function startPrintScan(){
  if(!isAndroid()){alert("Ch·ªâ h·ªó tr·ª£ Android");return;}
  const r=document.getElementById("printReader");
  r.innerHTML='<div class="scan-frame"><div class="scan-line"></div></div>';
  r.classList.remove("hidden");

  if(!qr2) qr2=new Html5Qrcode("printReader");
  qr2.start({facingMode:"environment"},scanConfig,
    code=>{
      addBarcode(code);
      qr2.stop().then(()=>{qr2.clear();r.classList.add("hidden");});
    }
  );
}

function addBarcode(code){
  let d=JSON.parse(localStorage.getItem(printKey)||"{}");
  d[code]=(d[code]||0)+1;
  localStorage.setItem(printKey,JSON.stringify(d));
  renderPrint();
}

function renderPrint(){
  const d=JSON.parse(localStorage.getItem(printKey)||"{}");
  printHistory.innerHTML=Object.entries(d).map(
    ([b,q])=>`<div>${b} , SL: ${q}</div>`
  ).join("");
}

/* ===== T√çNH HSD ===== */
function calculate(){
  if(!nsx.value||!hsd.value){alert("Thi·∫øu ng√†y");return;}
  const n=new Date(nsx.value), h=new Date(hsd.value);
  const total=(h-n)/86400000;
  const m30=new Date(n.getTime()+total*0.7*86400000);
  const m20=new Date(n.getTime()+total*0.8*86400000);
  result.innerHTML=`
  <div class="border p-2">M·ªëc 30%: ${m30.toLocaleDateString("vi-VN")}</div>
  <div class="border p-2 mt-2">M·ªëc 20%: ${m20.toLocaleDateString("vi-VN")}</div>`;
}

/* ===== EXCEL ===== */
function exportExcel(){
  const ws=XLSX.utils.json_to_sheet([{Barcode:barcode.value,NSX:nsx.value,HSD:hsd.value}]);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"HSD");
  XLSX.writeFile(wb,"hsd.xlsx");
}
</script>

</body>
</html>
