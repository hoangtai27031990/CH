<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>H·ªÜ TH·ªêNG QU·∫¢N L√ù HSD ‚Äì Saigon Co.op</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<style>
body{background:#f3f4f6}
.card{background:#fff;border-radius:14px;box-shadow:0 4px 16px rgba(0,0,0,.08)}
.brand-bg{background:#c40018}
.brand-text{color:#c40018}

.blink30{animation:blink30 .6s linear infinite;border:2px solid #fb923c}
@keyframes blink30{0%{background:#fff3e0}50%{background:#ff9800}100%{background:#fff3e0}}

.blink20{animation:blink20 .6s linear infinite;border:2px solid #ef4444}
@keyframes blink20{0%{background:#fff1f2}50%{background:#fecaca}100%{background:#fff1f2}}

#sidebar{position:fixed;top:0;left:0;width:260px;height:100%;background:#fff;box-shadow:4px 0 16px rgba(0,0,0,.15);transform:translateX(-100%);transition:.3s;z-index:1000}
#sidebar.active{transform:translateX(0)}
#overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;z-index:900}
#overlay.active{display:block}

.chat-box{height:420px;overflow:auto;background:#fafafa;border:1px solid #e5e7eb;border-radius:10px;padding:10px}
.chat-item{background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:6px 10px;margin-bottom:6px;font-family:monospace}

.filter-btn{padding:6px 12px;border-radius:6px;border:1px solid #ddd;background:#f5f5f5;font-size:13px}
.filter-btn.active{background:#2563eb;color:white}

#reader,#printReader{
 position:relative;
 width:100%;
 height:260px;
 background:#000;
}

.scan-line{
 position:absolute;
 left:5%;
 width:90%;
 height:4px;
 background:red;
 box-shadow:0 0 12px red;
 animation:scanMove 1.2s linear infinite;
 z-index:20;
}

@keyframes scanMove{
 0%{top:30%}
 50%{top:50%}
 100%{top:70%}
}
</style>
</head>

<body class="max-w-xl mx-auto p-3">

<!-- POPUP -->
<div id="alertPopup" class="hidden items-center justify-center fixed inset-0 bg-black/50 z-50">
  <div id="popupBox" class="bg-white p-5 rounded-xl w-[90%] max-w-sm text-center">
    <div id="popupTitle" class="font-bold text-lg mb-2"></div>
    <div id="popupMsg" class="mb-4"></div>
    <button onclick="closePopup()" class="brand-bg text-white px-4 py-2 rounded">ƒê√£ hi·ªÉu</button>
  </div>
</div>

<!-- HEADER -->
<div class="flex justify-between items-center mb-4 p-3 rounded-lg brand-bg text-white">
  <div class="font-bold">H·ªÜ TH·ªêNG QU·∫¢N L√ù HSD ‚Äì Saigon Co.op</div>
  <button onclick="toggleMenu()">‚ò∞</button>
</div>

<!-- SIDEBAR -->
<div id="sidebar">
  <div class="p-3 space-y-2">
    <button onclick="showMain()" class="w-full bg-red-50 p-2">üì¶ Qu·∫£n l√Ω HSD</button>
    <button onclick="showPrint()" class="w-full bg-slate-100 p-2">üñ® In b·∫£ng gi√° qu·∫ßy</button>
  </div>
</div>
<div id="overlay" onclick="toggleMenu()"></div>

<!-- MAIN -->
<div id="mainApp">
<div class="card p-4 space-y-3">

<label>Barcode</label>
<div class="flex gap-2">
<input id="barcode" class="border p-2 rounded w-full">
<button onclick="startScan()" class="brand-bg text-white px-3 rounded">Qu√©t</button>
</div>

<div id="reader" class="hidden"></div>

<label>NSX</label>
<input type="date" id="nsx" class="border p-2 rounded w-full">

<label>HSD</label>
<input type="date" id="hsd" class="border p-2 rounded w-full">

<div class="grid grid-cols-2 gap-2">
<button onclick="calculate()" class="brand-bg text-white py-2 rounded">T√çNH</button>
<button onclick="resetForm()" class="bg-gray-500 text-white py-2 rounded">T√çNH L·∫†I</button>
</div>

<div id="result"></div>

<div class="grid grid-cols-2 gap-2">
<button onclick="exportExcel()" class="bg-slate-700 text-white py-2 rounded">Xu·∫•t Excel</button>
<button onclick="clearHistory()" class="bg-red-600 text-white py-2 rounded">X√≥a l·ªãch s·ª≠</button>
</div>

<div id="statistic" class="text-sm"></div>

</div>

<div class="card p-3 mt-4">
<h2 class="font-bold brand-text mb-2">L·ªãch s·ª≠</h2>
<div id="history" class="text-sm space-y-1 max-h-64 overflow-auto"></div>
</div>
</div>

<!-- PRINT -->
<div id="printApp" class="hidden card p-4">
<button onclick="startPrintScan()" class="brand-bg text-white w-full py-2 rounded">üì∑ Qu√©t barcode</button>
<div id="printReader" class="hidden"></div>
<div id="printHistory" class="chat-box mt-2"></div>
</div>

<script>
/* KEYS */
const historyKey="coop_hsd_history";
const printKey="coop_print_history";

/* MENU */
const sidebar=document.getElementById("sidebar");
const overlay=document.getElementById("overlay");
const mainApp=document.getElementById("mainApp");
const printApp=document.getElementById("printApp");

function toggleMenu(){sidebar.classList.toggle("active");overlay.classList.toggle("active")}
function showMain(){mainApp.classList.remove("hidden");printApp.classList.add("hidden");toggleMenu()}
function showPrint(){mainApp.classList.add("hidden");printApp.classList.remove("hidden");toggleMenu()}

/* SCAN */
let qr=null,qr2=null;
const scanConfig={fps:6,qrbox:{width:260,height:90},disableFlip:true};

function startScan(){
 const r=document.getElementById("reader");
 r.innerHTML='<div class="scan-line"></div>';
 r.classList.remove("hidden");

 if(!qr) qr=new Html5Qrcode("reader");
 qr.start({facingMode:"environment"},scanConfig,code=>{
  barcode.value=code;
  qr.stop().then(()=>{qr.clear();r.classList.add("hidden")});
 });
}

function startPrintScan(){
 const r=document.getElementById("printReader");
 r.innerHTML='<div class="scan-line"></div>';
 r.classList.remove("hidden");

 if(!qr2) qr2=new Html5Qrcode("printReader");
 qr2.start({facingMode:"environment"},scanConfig,code=>{
  printHistory.innerHTML+=`<div class="chat-item">${code}</div>`;
  qr2.stop().then(()=>{qr2.clear();r.classList.add("hidden")});
 });
}

/* HSD */
function calculate(){
 if(!nsx.value||!hsd.value){alert("Nh·∫≠p ƒë·ªß NSX & HSD");return}
 const a=new Date(nsx.value),b=new Date(hsd.value);
 const total=(b-a)/86400000;
 const d30=new Date(a.getTime()+total*0.7*86400000);
 const d20=new Date(a.getTime()+total*0.8*86400000);
 result.innerHTML=`
 <div class="blink30 p-2 mb-2">M·ªëc 30%: ${d30.toLocaleDateString()}</div>
 <div class="blink20 p-2">M·ªëc 20%: ${d20.toLocaleDateString()}</div>`;
}

/* HISTORY */
function clearHistory(){localStorage.removeItem(historyKey);history.innerHTML=""}

/* EXPORT */
function exportExcel(){
 const ws=XLSX.utils.json_to_sheet([{Barcode:barcode.value,NSX:nsx.value,HSD:hsd.value}]);
 const wb=XLSX.utils.book_new();
 XLSX.utils.book_append_sheet(wb,ws,"HSD");
 XLSX.writeFile(wb,"saigoncoop_hsd.xlsx");
}

function resetForm(){barcode.value="";nsx.value="";hsd.value="";result.innerHTML=""}
</script>

</body>
</html>
