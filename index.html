<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>HỆ THỐNG QUẢN LÝ HSD – Production</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
</head>
<body class="bg-gray-100">

<div class="max-w-4xl mx-auto p-4">
  <h1 class="text-2xl font-bold mb-4">Quản lý HSD – Production Build</h1>

  <div class="flex gap-2 mb-4">
    <button onclick="App.showTab('main')" class="px-3 py-2 bg-blue-600 text-white rounded">Main App</button>
    <button onclick="App.showTab('print')" class="px-3 py-2 bg-green-600 text-white rounded">Print App</button>
  </div>

  <div id="mainTab">
    <div class="grid grid-cols-2 gap-3 mb-3">
      <input id="barcode" placeholder="Barcode" class="p-2 border rounded" />
      <input id="productName" placeholder="Tên sản phẩm" class="p-2 border rounded" />
      <input id="m30" type="date" class="p-2 border rounded" />
      <button onclick="App.calculate()" class="bg-indigo-600 text-white rounded p-2">Tính</button>
    </div>

    <div class="flex gap-2 mb-3">
      <button onclick="App.exportExcel()" class="bg-emerald-600 text-white px-3 py-2 rounded">Export Excel</button>
      <button onclick="App.startScan()" class="bg-purple-600 text-white px-3 py-2 rounded">Scan</button>
    </div>

    <div id="reader" class="mb-4"></div>

    <input id="filterInput" placeholder="Filter barcode" class="p-2 border rounded w-full mb-3" oninput="App.renderHistory()" />

    <div id="history" class="bg-white p-3 rounded shadow"></div>
  </div>

  <div id="printTab" class="hidden">
    <h2 class="text-xl font-semibold mb-3">In bảng giá quầy</h2>
    <div id="printHistory" class="bg-white p-3 rounded shadow"></div>
  </div>
</div>

<script type="module">

const Storage = (() => {
  const KEY = 'hsd_data_v2';
  const PRINT_KEY = 'print_data_v2';

  const get = () => JSON.parse(localStorage.getItem(KEY) || '[]');
  const set = (data) => localStorage.setItem(KEY, JSON.stringify(data));

  const getPrint = () => JSON.parse(localStorage.getItem(PRINT_KEY) || '{}');
  const setPrint = (data) => localStorage.setItem(PRINT_KEY, JSON.stringify(data));

  const autoClean = () => {
    const today = new Date().toISOString().split('T')[0];
    const clean = get().filter(i => i.m30 >= today);
    set(clean);
  };

  return { get, set, getPrint, setPrint, autoClean };
})();

const UI = (() => {
  const toast = (msg) => {
    const t = document.createElement('div');
    t.className = 'fixed bottom-4 right-4 bg-black text-white px-4 py-2 rounded';
    t.innerText = msg;
    document.body.appendChild(t);
    setTimeout(() => t.remove(), 2000);
  };

  const popup = (msg) => alert(msg);

  return { toast, popup };
})();

window.App = (() => {
  let scanner;

  const showTab = (tab) => {
    document.getElementById('mainTab').classList.toggle('hidden', tab !== 'main');
    document.getElementById('printTab').classList.toggle('hidden', tab !== 'print');
    if(tab==='print') renderPrint();
  };

  const calculate = () => {
    const barcode = document.getElementById('barcode').value.trim();
    const name = document.getElementById('productName').value.trim();
    const m30 = document.getElementById('m30').value;

    if(!barcode || !m30) return UI.toast('Thiếu dữ liệu');

    const data = Storage.get();
    data.push({ barcode, name, m30 });
    Storage.set(data);

    const print = Storage.getPrint();
    print[barcode] = name;
    Storage.setPrint(print);

    UI.toast('Đã lưu');
    renderHistory();
  };

  const renderHistory = () => {
    const filter = document.getElementById('filterInput').value;
    const box = document.getElementById('history');
    const data = Storage.get().filter(i => i.barcode.includes(filter));

    box.innerHTML = data.map(i => `
      <div class="border-b py-2 flex justify-between">
        <div>${i.barcode} - ${i.name}</div>
        <div>${i.m30}</div>
      </div>
    `).join('');
  };

  const renderPrint = () => {
    const box = document.getElementById('printHistory');
    const data = Storage.getPrint();
    box.innerHTML = Object.entries(data)
      .map(([b,n]) => `<div class="border-b py-2">${b} - ${n}</div>`)
      .join('');
  };

  const exportExcel = () => {
    const ws = XLSX.utils.json_to_sheet(Storage.get());
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'HSD');
    XLSX.writeFile(wb, 'hsd_export.xlsx');
  };

  const startScan = () => {
    scanner = new Html5Qrcode('reader');
    scanner.start(
      { facingMode: 'environment' },
      { fps: 10, qrbox: 250 },
      (decoded) => {
        document.getElementById('barcode').value = decoded;
        UI.toast('Scan thành công');
        scanner.stop();
      }
    );
  };

  const init = () => {
    Storage.autoClean();
    renderHistory();
  };

  document.addEventListener('DOMContentLoaded', init);

  return { showTab, calculate, renderHistory, exportExcel, startScan };
})();

</script>

</body>
</html>
