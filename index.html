<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>H·ªÜ TH·ªêNG QU·∫¢N L√ù HSD ‚Äì Saigon Co.op</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<style>
body{background:#f3f4f6}
.card{background:#fff;border-radius:14px;box-shadow:0 4px 16px rgba(0,0,0,.08)}
.brand-bg{background:#c40018}
.brand-text{color:#c40018}

/* ===== Sidebar ===== */
#sidebar{position:fixed;top:0;left:0;width:260px;height:100%;background:#fff;box-shadow:4px 0 16px rgba(0,0,0,.15);transform:translateX(-100%);transition:.3s;z-index:1000}
#sidebar.active{transform:translateX(0)}
#overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;z-index:900}
#overlay.active{display:block}

/* ===== Scan overlay ===== */
.scan-wrapper{position:relative}
.scan-overlay{
 position:absolute;
 inset:0;
 z-index:20;
 pointer-events:none;
 display:flex;
 align-items:center;
 justify-content:center;
}
.scan-line{
 width:85%;
 height:3px;
 background:#dc2626;
 box-shadow:0 0 15px rgba(220,38,38,.9);
 animation:pulse 1.2s infinite;
}
@keyframes pulse{0%{opacity:.3}50%{opacity:1}100%{opacity:.3}}

.chat-box{max-height:280px;overflow:auto;background:#fafafa;border:1px solid #e5e7eb;border-radius:10px;padding:8px}
.chat-item{background:#fff;border:1px solid #e5e7eb;border-radius:8px;padding:6px;margin-bottom:6px;font-family:monospace}

#alertPopup{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:3000}
.popup-30{border:3px solid #fb923c}
.popup-20{border:3px solid #ef4444}
</style>
</head>

<body class="max-w-xl mx-auto p-3">

<!-- POPUP -->
<div id="alertPopup" class="hidden items-center justify-center">
  <div id="popupBox" class="bg-white p-5 rounded-xl w-[90%] max-w-sm text-center">
    <div id="popupTitle" class="font-bold text-lg mb-2"></div>
    <div id="popupMsg" class="mb-4"></div>
    <button onclick="closePopup()" class="brand-bg text-white px-4 py-2 rounded">ƒê√£ hi·ªÉu</button>
  </div>
</div>

<!-- SIDEBAR -->
<div id="sidebar">
  <div class="p-4 border-b text-center font-bold brand-text">Saigon Co.op</div>
  <div class="p-3 space-y-2">
    <button onclick="showMain()" class="w-full text-left px-3 py-2 rounded bg-red-50">üì¶ Qu·∫£n l√Ω HSD</button>
    <button onclick="showPrint()" class="w-full text-left px-3 py-2 rounded bg-slate-100">üñ® In b·∫£ng gi√°</button>
    <button onclick="exportExcel()" class="w-full text-left px-3 py-2 rounded bg-slate-100">üì§ Xu·∫•t Excel</button>
  </div>
</div>
<div id="overlay" onclick="toggleMenu()"></div>

<!-- HEADER -->
<div class="flex justify-between items-center mb-3 p-3 rounded-lg brand-bg text-white">
  <div class="font-bold">H·ªÜ TH·ªêNG QU·∫¢N L√ù HSD</div>
  <button onclick="toggleMenu()" class="text-2xl">‚ò∞</button>
</div>

<!-- MAIN -->
<div id="mainApp" class="card p-4 space-y-3">

<label class="font-semibold">Barcode</label>
<div class="flex gap-2">
<input id="barcode" class="border p-2 rounded w-full">
<button onclick="startScan()" class="brand-bg text-white px-3 rounded">Qu√©t</button>
</div>

<div id="reader" class="hidden scan-wrapper mt-2">
  <div class="scan-overlay"><div class="scan-line"></div></div>
</div>

<label>NSX</label>
<input type="date" id="nsx" class="border p-2 rounded w-full">
<label>HSD</label>
<input type="date" id="hsd" class="border p-2 rounded w-full">

<button onclick="calculate()" class="brand-bg text-white py-2 rounded">T√çNH</button>

<div id="result"></div>

<h3 class="font-bold mt-3">L·ªãch s·ª≠</h3>
<div id="history" class="chat-box"></div>

</div>

<!-- PRINT -->
<div id="printApp" class="hidden card p-4">
<h2 class="font-bold mb-2">IN B·∫¢NG GI√Å</h2>
<button onclick="exportText()" class="brand-bg text-white px-4 py-2 rounded">Xu·∫•t TXT</button>
<div id="printHistory" class="chat-box mt-2"></div>
</div>

<script>
const historyKey="coop_hsd_history";
const printKey="coop_print_history";

let qr=null;
const scanConfig={
 fps:10,
 qrbox:{width:320,height:120},
 aspectRatio:16/9,
 experimentalFeatures:{useBarCodeDetectorIfSupported:true},
 formatsToSupport:[
  Html5QrcodeSupportedFormats.EAN_13,
  Html5QrcodeSupportedFormats.EAN_8,
  Html5QrcodeSupportedFormats.CODE_128,
  Html5QrcodeSupportedFormats.UPC_A
 ]
};

function toggleMenu(){
 sidebar.classList.toggle("active");
 overlay.classList.toggle("active");
}

function showMain(){
 mainApp.classList.remove("hidden");
 printApp.classList.add("hidden");
 toggleMenu();
}
function showPrint(){
 mainApp.classList.add("hidden");
 printApp.classList.remove("hidden");
 toggleMenu();
 renderPrint();
}

function startScan(){
 reader.classList.remove("hidden");
 if(!qr) qr=new Html5Qrcode("reader");
 qr.start({facingMode:"environment"},scanConfig,code=>{
  barcode.value=code;
  savePrint(code);
  qr.stop().then(()=>qr.clear());
  reader.classList.add("hidden");
 });
}

function calculate(){
 if(!nsx.value||!hsd.value){alert("Nh·∫≠p ƒë·ªß NSX v√† HSD");return}
 const nsxD=new Date(nsx.value);
 const hsdD=new Date(hsd.value);
 const total=(hsdD-nsxD)/86400000;

 const d30=new Date(nsxD.getTime()+total*0.7*86400000);
 const d20=new Date(nsxD.getTime()+total*0.8*86400000);
 const today=new Date();

 let warn="";
 if(today>=d20){showPopup("20");warn="R√∫t h√†ng"}
 else if(today>=d30){showPopup("30");warn="Gi·∫£i t·ªìn"}

 result.innerHTML=`
 <div class="border p-2">30%: ${d30.toLocaleDateString("vi-VN")}</div>
 <div class="border p-2">20%: ${d20.toLocaleDateString("vi-VN")}</div>
 `;

 let h=JSON.parse(localStorage.getItem(historyKey)||"[]");
 h.unshift({barcode:barcode.value,nsx:nsx.value,hsd:hsd.value,canhbao:warn,time:new Date().toLocaleString("vi-VN")});
 localStorage.setItem(historyKey,JSON.stringify(h));
 renderHistory();
}

function renderHistory(){
 let h=JSON.parse(localStorage.getItem(historyKey)||"[]");
 history.innerHTML=h.map(x=>`
  <div class="chat-item">
   ${x.barcode}<br>
   ${x.nsx} ‚Üí ${x.hsd}<br>
   ${x.canhbao||"B√¨nh th∆∞·ªùng"}
  </div>`).join("");
}

function exportExcel(){
 let h=JSON.parse(localStorage.getItem(historyKey)||"[]");
 if(!h.length){alert("Kh√¥ng c√≥ d·ªØ li·ªáu");return}
 const ws=XLSX.utils.json_to_sheet(h);
 const wb=XLSX.utils.book_new();
 XLSX.utils.book_append_sheet(wb,ws,"HSD");
 XLSX.writeFile(wb,"saigoncoop_hsd.xlsx");
}

function savePrint(code){
 let p=JSON.parse(localStorage.getItem(printKey)||"{}");
 p[code]=(p[code]||0)+1;
 localStorage.setItem(printKey,JSON.stringify(p));
}

function renderPrint(){
 let p=JSON.parse(localStorage.getItem(printKey)||"{}");
 printHistory.innerHTML=Object.entries(p).map(([b,q])=>`${b},${q}`).join("<br>");
}

function exportText(){
 let p=JSON.parse(localStorage.getItem(printKey)||"{}");
 let txt=Object.entries(p).map(([b,q])=>`${b},${q}`).join("\n");
 const blob=new Blob([txt],{type:"text/plain"});
 const a=document.createElement("a");
 a.href=URL.createObjectURL(blob);
 a.download="barcode_print.txt";
 a.click();
}

function showPopup(type){
 popupTitle.innerText=type==="20"?"C·∫¢NH B√ÅO 20%":"C·∫¢NH B√ÅO 30%";
 popupMsg.innerText=type==="20"?"R√∫t h√†ng kh·ªèi qu·∫ßy":"B√°o qu·∫£n l√Ω ƒë·ªÉ gi·∫£i t·ªìn";
 popupBox.className="bg-white p-5 rounded-xl popup-"+type;
 alertPopup.classList.remove("hidden");
 alertPopup.classList.add("flex");
}

function closePopup(){
 alertPopup.classList.add("hidden");
 alertPopup.classList.remove("flex");
}

renderHistory();
</script>

</body>
</html>
