<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>HỆ THỐNG QUẢN LÝ HSD – Saigon Co.op</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<style>
body{background:#f3f4f6}
.card{background:#fff;border-radius:14px;box-shadow:0 4px 16px rgba(0,0,0,.08)}
.brand-bg{background:#c40018}
.brand-text{color:#c40018}

.blink30{animation:blink30 .6s linear infinite;border:2px solid #fb923c}
@keyframes blink30{0%{background:#fff3e0}50%{background:#ff9800;box-shadow:0 0 20px rgba(251,146,60,1)}100%{background:#fff3e0}}

.blink20{animation:blink20 .6s linear infinite;border:2px solid #ef4444}
@keyframes blink20{0%{background:#fff1f2}50%{background:#fecaca;box-shadow:0 0 20px rgba(239,68,68,1)}100%{background:#fff1f2}}

#reader,#printReader{
  position:relative;
  border:2px dashed #c40018;
  border-radius:12px;
  padding:8px;
}
.scan-box{
  position:absolute;
  inset:35% 10%;
  border:3px solid rgba(255,0,0,.7);
  border-radius:10px;
  pointer-events:none;
}

</style>
</head>

<body class="max-w-xl mx-auto p-3">

<!-- ===== UI GIỮ NGUYÊN ===== -->
<!-- (toàn bộ HTML phía trên bạn giữ nguyên như đã gửi) -->

<script>
/* ===============================
   CAMERA & BARCODE – BẢN TỐI ƯU
   =============================== */

let qr=null, qr2=null;
let detector=null;

/* Khởi tạo BarcodeDetector nếu có */
if ('BarcodeDetector' in window) {
  try {
    detector = new BarcodeDetector({
      formats: ['ean_13','ean_8','code_128','upc_a','upc_e']
    });
  } catch(e){}
}

/* ===== Scan bằng BarcodeDetector (ưu tiên) ===== */
async function startNativeScan(targetInput, containerId){
  try{
    const stream = await navigator.mediaDevices.getUserMedia({
      video:{
        facingMode:"environment",
        width:{ideal:1280},
        height:{ideal:720}
      }
    });

    const video=document.createElement("video");
    video.srcObject=stream;
    video.setAttribute("playsinline",true);
    video.play();

    const container=document.getElementById(containerId);
    container.innerHTML="";
    container.classList.remove("hidden");
    container.appendChild(video);

    const box=document.createElement("div");
    box.className="scan-box";
    container.appendChild(box);

    const canvas=document.createElement("canvas");
    const ctx=canvas.getContext("2d");

    const scan=async()=>{
      if(video.readyState===video.HAVE_ENOUGH_DATA){
        canvas.width=video.videoWidth;
        canvas.height=video.videoHeight;
        ctx.drawImage(video,0,0);

        const codes=await detector.detect(canvas);
        if(codes.length){
          targetInput.value=codes[0].rawValue;
          stream.getTracks().forEach(t=>t.stop());
          container.classList.add("hidden");
          return;
        }
      }
      requestAnimationFrame(scan);
    };
    scan();
  }catch(e){
    alert("Không thể mở camera. Vui lòng cấp quyền camera.");
  }
}

/* ===== Fallback html5-qrcode ===== */
const scanConfig={
  fps:10,
  disableFlip:true,
  qrbox:{width:260,height:120}
};

/* ===== Scan MAIN ===== */
function startScan(){
  const r=document.getElementById("reader");
  if(detector){
    startNativeScan(barcode,"reader");
    return;
  }
  r.classList.remove("hidden");
  if(!qr) qr=new Html5Qrcode("reader");
  qr.start({facingMode:"environment"},scanConfig,code=>{
    barcode.value=code;
    qr.stop().then(()=>qr.clear());
    r.classList.add("hidden");
  },()=>{}).catch(()=>{
    alert("Không thể mở camera");
  });
}

/* ===== Scan PRINT ===== */
function startPrintScan(){
  const r=document.getElementById("printReader");
  if(detector){
    startNativeScan({value:"",set value(v){addBarcode(v)} },"printReader");
    return;
  }
  r.classList.remove("hidden");
  if(!qr2) qr2=new Html5Qrcode("printReader");
  qr2.start({facingMode:"environment"},scanConfig,code=>{
    addBarcode(code);
    qr2.stop().then(()=>qr2.clear());
    r.classList.add("hidden");
  },()=>{}).catch(()=>{
    alert("Không thể mở camera");
  });
}

/* ===== TOÀN BỘ LOGIC KHÁC GIỮ NGUYÊN ===== */
</script>

</body>
</html>
